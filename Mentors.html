<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Micro-Learning</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Tailwind Configuration: Blue & White Theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#3b82f6', // Blue 500
                        'primary-dark': '#1d4ed8', // Blue 700
                        'secondary': '#0d9488', // Teal 600 (Used for success/post actions)
                        'background-light': '#ffffff',
                        'card-bg': '#eff6ff', // Blue 50 (Very light blue for cards)
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Lighter Gray Background */
        }
        .post-card {
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        .modal {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            z-index: 50;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .post-item {
            animation: fadeIn 0.5s ease-out;
        }
        .media-btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #bfdbfe; /* Blue 200 */
            color: #1d4ed8; /* Primary Dark */
            transition: background-color 0.15s, transform 0.1s;
        }
        .media-btn-icon:hover {
            background-color: #60a5fa; /* Blue 400 */
            transform: scale(1.05);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header (Blue Theme) -->
    <header class="sticky top-0 bg-white shadow-lg p-4 flex justify-between items-center z-40 border-b-2 border-primary-dark">
        <h1 class="text-2xl font-extrabold text-primary-dark tracking-wide">Daily<span class="text-primary">Learn</span></h1>
        <div class="flex space-x-3">
            <!-- Filter Button -->
            <button id="filterBtn" class="p-2 text-primary-dark hover:text-primary transition duration-150 rounded-full bg-blue-100 hover:bg-blue-200 shadow-md" title="Filter Feed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707v3.586L9 21v-3.586a1 1 0 00-.293-.707L2.293 7.293A1 1 0 012 6.586V4a1 1 0 011-1z" />
                </svg>
            </button>
            <!-- Post Button -->
            <button id="postBtn" class="p-2 text-white bg-primary hover:bg-primary-dark transition duration-150 rounded-full shadow-lg" title="Create New Post">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content: Feed -->
    <main class="max-w-xl mx-auto p-4 pt-6 md:pt-10">
        <div id="loadingIndicator" class="text-center text-gray-500 py-10">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-dark mx-auto mb-2"></div>
            Loading learning posts...
        </div>
        <div id="feedContainer" class="space-y-8">
            <!-- Posts will be injected here by JavaScript -->
        </div>
        <div id="emptyFeed" class="hidden text-center text-gray-500 p-10 mt-10 border-2 border-dashed border-primary/50 bg-blue-50 rounded-xl">
            <p class="text-lg font-semibold mb-2">You're all caught up!</p>
            <p>You have viewed all available lessons in this category.</p>
        </div>
    </main>

    <!-- Post Modal -->
    <div id="postModal" class="modal fixed inset-0 hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 transform transition-all duration-300 max-h-[90vh] overflow-y-auto border border-primary-dark/20">
            <h2 class="text-2xl font-bold mb-4 text-primary-dark">Share Value</h2>
            <form id="postForm">
                <p class="text-xs text-gray-500 mb-3">Your User ID: <span id="currentUserId" class="font-mono text-xs bg-gray-100 px-1 rounded">Loading...</span></p>

                <div class="mb-4">
                    <label for="postCategory" class="block text-sm font-medium text-gray-700">Category</label>
                    <select id="postCategory" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 border">
                        <!-- Options filled by JS -->
                    </select>
                </div>

                <!-- Lesson Content Area (Text or Media Trigger) -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Text Lesson / Media Caption</label>
                    <textarea id="postContentText" rows="3" placeholder="Write your quick lesson or media caption here." class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 border" required></textarea>
                    
                    <div class="flex space-x-4 mt-2 justify-center p-2 rounded-b-lg border-t border-gray-200">
                        <button type="button" class="media-btn-icon" title="Upload File (Image/Video/Audio)" onclick="document.getElementById('postContentFile').click()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                        <button type="button" class="media-btn-icon" title="Open Camera (Image/Video Capture)" onclick="document.getElementById('postContentFile').click()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" /></svg>
                        </button>
                        <button type="button" class="media-btn-icon" title="Record Audio" onclick="document.getElementById('postContentFile').click()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z" clip-rule="evenodd" /><path d="M12 14c0 1.333-.09 2.597-.282 3.732.337.135.65.297.941.488a1 1 0 001.373-.805L14 14.5a3 3 0 01-3 3.5v2a1 1 0 11-2 0v-2a3 3 0 01-3-3.5l.034.02c.427.147.887.27 1.373.354.192-.486.342-.998.44-1.543l.034-.144A5 5 0 008 14V8h4v6z" /></svg>
                        </button>
                    </div>
                    
                    <!-- Hidden input to handle all file selections -->
                    <input type="file" id="postContentFile" accept="image/*,audio/*,video/*" class="hidden" onchange="handleFileSelection(this.files[0])">
                    
                    <p class="text-xs text-gray-500 mt-1" id="fileInfo">
                        No file selected.
                    </p>
                    <p class="text-xs text-red-500 mt-1" id="fileWarning">
                        <strong class="font-bold">NOTE:</strong> This demo only captures file metadata. For production, you MUST implement Firebase Storage.
                    </p>
                </div>

                <h3 class="text-lg font-semibold mb-3 text-primary-dark border-b pb-1 border-primary/50">Setup Quick Exam (1 to 3 Questions)</h3>

                <div id="examQuestionsContainer" class="space-y-4">
                    <!-- Question 1 (Mandatory) -->
                </div>

                <div class="mt-4">
                    <button type="button" id="addQuestionBtn" class="text-sm px-3 py-2 bg-blue-100 text-primary-dark rounded-lg hover:bg-blue-200 transition shadow-sm">
                        Add Question (Max 3)
                    </button>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="closePostModal" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-white bg-secondary rounded-lg hover:bg-teal-700 transition shadow-md">Post Lesson</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Exam Modal (Content, Learn, and Quiz) -->
    <div id="examModal" class="modal fixed inset-0 hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 transform transition-all duration-300 max-h-[90vh] overflow-y-auto border border-primary-dark/20">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-primary-dark">Lesson Preview</h2>
            
            <div id="lessonContentContainer" class="border rounded-xl p-4 mb-4 bg-card-bg border-primary/40 max-h-60 overflow-y-auto">
                <!-- Lesson content/media injected here -->
            </div>
            
            <div id="quizContainer" class="hidden">
                <h3 class="text-xl font-bold mt-6 mb-3 text-primary-dark border-t pt-4">Your Challenge</h3>
                <form id="examForm"><!-- Questions injected here --></form>
                
                <div id="examResults" class="hidden mt-4 p-4 rounded-lg">
                    <p class="font-semibold text-lg mb-2"></p>
                    <p class="text-sm"></p>
                    <div class="mt-4 flex space-x-3">
                        <button id="likeBtn" class="flex items-center space-x-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition shadow-md" title="Like the post" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>
                            <span>Like</span>
                        </button>
                        <button id="ratingBtn" class="flex items-center space-x-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition shadow-md" title="Rate the post 5/5" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.381-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                            <span>Rate (5/5)</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button id="closeExamModal" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Close</button>
                <button id="startExamBtn" class="px-4 py-2 text-white bg-primary rounded-lg hover:bg-primary-dark transition shadow-md">Start Exam</button>
                <button id="submitExamBtn" class="px-4 py-2 text-white bg-secondary rounded-lg hover:bg-teal-700 transition shadow-md hidden">Submit Exam</button>
            </div>
        </div>
    </div>

    <!-- Filter Modal -->
    <div id="filterModal" class="modal fixed inset-0 hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 transform transition-all duration-300 border border-primary-dark/20">
            <h2 class="text-xl font-bold mb-4 text-primary-dark">Filter Learning Feed</h2>
            <p class="text-sm text-gray-500 mb-4">Viewing posts in category: <span class="font-bold text-primary-dark" id="currentFilterDisplay">All</span></p>
            <div id="filterOptions" class="space-y-2">
                <!-- Filter buttons injected here -->
            </div>
            <div class="mt-6 flex justify-end">
                <button id="closeFilterModal" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Done</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level for debugging
        setLogLevel('Debug');

        // --- GLOBAL VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let currentFilter = 'All'; // Default filter
        const CATEGORIES = [
            'All', 'Technology', 'Finance', 'History', 'Science', 'Art', 'Wellness',
            'Programming', 'Marketing', 'Cooking', 'Music', 'Languages', 'DIY'
        ];
        let postsData = []; // Full list of posts
        let completedExamsData = new Set(); // Set of post IDs the user has completed
        let selectedMediaFile = null; // Track the currently selected file

        // Elements
        const loadingIndicator = document.getElementById('loadingIndicator');
        const feedContainer = document.getElementById('feedContainer');
        const emptyFeed = document.getElementById('emptyFeed');
        const postModal = document.getElementById('postModal');
        const examModal = document.getElementById('examModal');
        const filterModal = document.getElementById('filterModal');
        const postCategorySelect = document.getElementById('postCategory');
        const examQuestionsContainer = document.getElementById('examQuestionsContainer');
        const currentUserIdDisplay = document.getElementById('currentUserId');
        const currentFilterDisplay = document.getElementById('currentFilterDisplay');
        const postContentText = document.getElementById('postContentText');
        const fileInfo = document.getElementById('fileInfo');
        const postContentFile = document.getElementById('postContentFile');
        
        const modalTitle = document.getElementById('modalTitle');
        const lessonContentContainer = document.getElementById('lessonContentContainer');
        const quizContainer = document.getElementById('quizContainer');
        const startExamBtn = document.getElementById('startExamBtn');
        const submitExamBtn = document.getElementById('submitExamBtn');
        const closeExamModalBtn = document.getElementById('closeExamModal');


        // --- FILE HANDLING LOGIC ---

        window.handleFileSelection = function(file) {
            selectedMediaFile = file;
            if (file) {
                fileInfo.textContent = `File Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB) - Type: ${file.type.split('/')[0].toUpperCase()}`;
                fileInfo.classList.remove('text-gray-500');
                fileInfo.classList.add('text-secondary', 'font-semibold');
            } else {
                fileInfo.textContent = 'No file selected.';
                fileInfo.classList.add('text-gray-500');
                fileInfo.classList.remove('text-secondary', 'font-semibold');
            }
        }


        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    currentUserIdDisplay.textContent = userId;
                } else {
                    console.warn("No user found. Signing in anonymously.");
                    try {
                        // Use signInWithCustomToken if available, otherwise sign in anonymously
                        if (initialAuthToken) {
                             await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        userId = auth.currentUser.uid;
                        currentUserIdDisplay.textContent = userId;
                    } catch (error) {
                        console.error("Auth failed:", error);
                    }
                }
                isAuthReady = true;
                console.log("Auth Ready. User ID:", userId);
                await checkAndSeedMockData();
                setupFirestoreListeners();
            });

        } catch (e) {
            console.error("Error initializing Firebase:", e);
            loadingIndicator.textContent = "Error loading application. Check console for details.";
        }

        // --- MOCK DATA SEEDING ---

        const mockPosts = [
            {
                category: 'Technology',
                content: 'The core difference between JavaScript Promises and Callbacks is that Promises manage asynchronous operations in a cleaner, chained manner, avoiding the Callback Hell typical of deeply nested functions. Promises have states: pending, fulfilled, or rejected.',
                media: null,
                exam: {
                    questions: [
                        { q: 'What are the three states of a JavaScript Promise?', options: ['Pending, Running, Complete', 'Pending, Fulfilled, Rejected', 'Start, Progress, End'], correct: 'B' }
                    ]
                }
            },
            {
                category: 'Finance',
                content: 'Audio lesson on compounding interest. Compounding is earning interest on interest. The longer your money compounds, the faster it grows. Key takeaway: Start investing early!',
                media: { type: 'audio/mp3', url: 'MOCK_AUDIO_URL_COMPOUNDING.mp3' },
                exam: {
                    questions: [
                        { q: 'What is the main benefit of compounding interest?', options: ['It stops banks from charging fees.', 'It allows interest to be earned on previous interest.', 'It guarantees a higher stock market return.'], correct: 'B' },
                        { q: 'The power of compounding is most significant over:', options: ['Short periods', 'Medium periods', 'Long periods'], correct: 'C' }
                    ]
                }
            },
            {
                category: 'Wellness',
                content: 'Image demonstrating the correct form for a plank exercise. A proper plank involves a straight line from your head to your heels, engaged core, and relaxed neck. Only hold for 30-60 seconds to start.',
                media: { type: 'image/jpeg', url: 'https://placehold.co/400x300/3b82f6/ffffff?text=Plank+Form+Demo' },
                exam: {
                    questions: [
                        { q: 'In a proper plank, your body should form a straight line from:', options: ['Elbows to knees', 'Head to hips', 'Head to heels'], correct: 'C' },
                    ]
                }
            },
        ];

        async function checkAndSeedMockData() {
            const postsRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily_learn_posts');
            const snapshot = await getDocs(postsRef);

            if (snapshot.empty) {
                console.log("Seeding mock data...");
                for (const post of mockPosts) {
                    await addDoc(postsRef, {
                        ...post,
                        authorId: 'MOCK-AUTHOR-SEED-' + Math.random().toString(36).substring(2, 6).toUpperCase(),
                        likes: Math.floor(Math.random() * 50) + 5,
                        authorRating: (Math.random() * 1.5 + 3.5).toFixed(1), // 3.5 to 5.0
                        timestamp: serverTimestamp(),
                    });
                }
                console.log("Mock data seeding complete.");
            }
        }

        // --- FIRESTORE LISTENERS ---

        function setupFirestoreListeners() {
            if (!isAuthReady || !userId) return;

            // 1. Listen for ALL Public Posts (Feed Data)
            const postsRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily_learn_posts');
            onSnapshot(postsRef, (snapshot) => {
                postsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFeed();
            }, (error) => {
                console.error("Error fetching posts:", error);
            });

            // 2. Listen for User's Private Completed Exams (View Once Tracker)
            const examsRef = collection(db, 'artifacts', appId, 'users', userId, 'completed_exams');
            onSnapshot(examsRef, (snapshot) => {
                completedExamsData = new Set(snapshot.docs.map(doc => doc.data().postId));
                renderFeed();
            }, (error) => {
                console.error("Error fetching completed exams:", error);
            });
        }


        // --- UI & RENDERING ---

        const AVATAR_URL = (id) => `https://placehold.co/50x50/3b82f6/ffffff?text=${id.substring(0, 2)}`;

        function getStarRating(rating) {
            const roundedRating = Math.round(rating);
            let stars = '';
            for (let i = 0; i < 5; i++) {
                if (i < roundedRating) {
                    stars += `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.381-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>`;
                } else {
                    stars += `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.381-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>`;
                }
            }
            return `<div class="flex items-center space-x-0.5">${stars}</div>`;
        }

        function renderFeed() {
            loadingIndicator.classList.add('hidden');
            feedContainer.innerHTML = '';
            currentFilterDisplay.textContent = currentFilter;

            const filteredPosts = postsData.filter(post => {
                const isCompleted = completedExamsData.has(post.id);
                const passesCategoryFilter = currentFilter === 'All' || post.category === currentFilter;
                return !isCompleted && passesCategoryFilter;
            });

            if (filteredPosts.length === 0) {
                emptyFeed.classList.remove('hidden');
                return;
            }
            emptyFeed.classList.add('hidden');

            filteredPosts.sort((a, b) => {
                const scoreA = (a.likes || 0) * 5 + (a.authorRating || 0);
                const scoreB = (b.likes || 0) * 5 + (b.authorRating || 0);
                return scoreB - scoreA;
            });

            filteredPosts.forEach(post => {
                const card = document.createElement('div');
                card.id = `post-${post.id}`;
                card.classList.add('post-card', 'bg-card-bg', 'p-4', 'rounded-xl', 'shadow-xl', 'border', 'border-primary/20', 'post-item');

                // Generate a simple title based on the first few words of the content, if no media
                const title = post.media 
                    ? `[${post.media.type.split('/')[0].toUpperCase()} Lesson]`
                    : post.content.split(/\s+/).slice(0, 5).join(' ') + '...';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <span class="inline-flex items-center px-3 py-1 text-xs font-bold text-primary-dark bg-blue-200 rounded-full">${post.category}</span>
                        <div class="flex flex-col items-end">
                            ${getStarRating(parseFloat(post.authorRating) || 4)}
                            <span class="text-xs font-semibold text-gray-700 mt-0.5">${(parseFloat(post.authorRating) || 4).toFixed(1)} Rating</span>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-bold text-gray-900 mb-2">${title}</h3>
                    
                    <div class="flex justify-between items-center pt-3 border-t border-primary/10">
                        <div class="flex items-center space-x-2">
                             <img src="${AVATAR_URL(post.authorId)}" alt="Avatar" class="w-8 h-8 rounded-full border border-primary-dark">
                            <span class="text-sm text-gray-600">
                                ${post.authorId.substring(0, 15)}...
                            </span>
                        </div>
                        <button class="learn-btn px-4 py-2 text-white bg-primary rounded-lg hover:bg-primary-dark transition shadow-md font-semibold" data-post-id="${post.id}">
                            Learn
                        </button>
                    </div>
                `;
                feedContainer.appendChild(card);
            });

            document.querySelectorAll('.learn-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.currentTarget.dataset.postId;
                    const post = postsData.find(p => p.id === postId);
                    if (post) {
                        openExamModal(post); // Now called openExamModal but handles the learn stage first
                    }
                });
            });
        }


        // --- MODAL & FORM CONTROLS ---

        function openModal(modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = 'auto';
            
            // Clear file info on close (for postModal)
            if(modal.id === 'postModal') {
                selectedMediaFile = null;
                postContentFile.value = '';
                handleFileSelection(null);
            }
            
            // Reset exam modal state on close (for examModal)
            if(modal.id === 'examModal') {
                activePost = null;
                quizContainer.classList.add('hidden');
                lessonContentContainer.style.display = 'block';
                startExamBtn.classList.remove('hidden');
                submitExamBtn.classList.add('hidden');
                document.getElementById('examResults').classList.add('hidden');
                document.getElementById('likeBtn').disabled = true;
                document.getElementById('ratingBtn').disabled = true;
            }
        }

        // Initialize category dropdown
        function initCategorySelect() {
            postCategorySelect.innerHTML = CATEGORIES.slice(1).map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }
        initCategorySelect();

        document.getElementById('postBtn').addEventListener('click', () => {
            openModal(postModal);
        });
        document.getElementById('closePostModal').addEventListener('click', () => closeModal(postModal));
        document.getElementById('closeExamModal').addEventListener('click', () => closeModal(examModal));


        // --- POSTING LOGIC (INCLUDING DYNAMIC QUESTIONS) ---

        const LETTERS = ['A', 'B', 'C'];
        
        function generateQuestionTemplate(index) {
            const isRemovable = index > 1;
            const removeButtonHtml = isRemovable ? 
                `<button type="button" class="remove-question-btn text-red-500 hover:text-red-700 text-sm font-medium" data-question-index="${index}">Remove</button>` : '';

            return `
                <div class="question-card p-3 bg-gray-50 rounded-lg border border-gray-200" data-question-index="${index}">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-bold text-gray-700">Question ${index}</label>
                        ${removeButtonHtml}
                    </div>
                    
                    <input type="text" placeholder="Question text" required class="question-text w-full p-2 border rounded-lg mb-3">
                    
                    <div class="grid grid-cols-1 gap-2">
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Select the correct answer below:</label>
                        ${LETTERS.map(letter => `
                            <div class="flex items-center bg-white p-2 rounded-lg border border-gray-300">
                                <label for="q${index}-correct-${letter}" class="flex items-center text-xs font-semibold mr-2 cursor-pointer">
                                    <input type="radio" name="q${index}-correct" id="q${index}-correct-${letter}" value="${letter}" class="form-radio text-secondary border-gray-300 focus:ring-secondary mr-2" ${letter === 'A' && index === 1 ? 'checked' : ''} required>
                                    ${letter}.
                                </label>
                                <input type="text" placeholder="Option ${letter} Text" required data-option="${letter}" class="answer-option w-full p-1 text-sm border-l pl-2">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Initial question setup
        examQuestionsContainer.innerHTML = generateQuestionTemplate(1);

        
        // Add Question
        document.getElementById('addQuestionBtn').addEventListener('click', () => {
            const currentCount = examQuestionsContainer.children.length;
            if (currentCount < 3) {
                examQuestionsContainer.insertAdjacentHTML('beforeend', generateQuestionTemplate(currentCount + 1));
            }
            if (currentCount + 1 === 3) document.getElementById('addQuestionBtn').disabled = true;
        });

        // Event delegation for Remove Button
        examQuestionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-question-btn')) {
                const qCard = e.target.closest('.question-card');
                if (qCard) {
                    qCard.remove();
                    // Re-index remaining questions
                    Array.from(examQuestionsContainer.children).forEach((card, index) => {
                        const newIndex = index + 1;
                        card.dataset.questionIndex = newIndex;
                        // Update question number text
                        card.querySelector('.question-card > div:first-child > label').textContent = `Question ${newIndex}`;
                        // Update remove button index
                        const removeBtn = card.querySelector('.remove-question-btn');
                        if(removeBtn) removeBtn.dataset.questionIndex = newIndex;

                        // Update radio button names and IDs
                        card.querySelectorAll('input[type="radio"]').forEach(radio => {
                             const optionLetter = radio.value;
                             radio.name = `q${newIndex}-correct`;
                             radio.id = `q${newIndex}-correct-${optionLetter}`;
                             card.querySelector(`label[for="q${newIndex}-correct-${optionLetter}"]`).htmlFor = radio.id;
                        });
                    });
                    document.getElementById('addQuestionBtn').disabled = false;
                }
            }
        });

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady || !userId) {
                alert("User not authenticated. Please wait for authentication.");
                return;
            }

            const category = postCategorySelect.value;
            let content = postContentText.value.trim();
            let media = null;
            
            if (content.length === 0 && !selectedMediaFile) {
                alert('Please provide some text content or select a media file.');
                return;
            }

            // Handle Media File
            if (selectedMediaFile) {
                // If a file is selected, update the content and media object
                if (content.length === 0) content = `[${selectedMediaFile.type.split('/')[0].toUpperCase()} Post]`;
                media = { 
                    type: selectedMediaFile.type, 
                    name: selectedMediaFile.name, 
                    // In a real app, this URL would be from Firebase Storage upload
                    url: `MOCK_URL_${Date.now()}` 
                };
            }
            
            // Extract Exam Data
            const questions = [];
            let allOptionsValid = true;

            document.querySelectorAll('.question-card').forEach(qDiv => {
                const questionText = qDiv.querySelector('.question-text').value.trim();
                const correctRadio = qDiv.querySelector(`input[name="q${qDiv.dataset.questionIndex}-correct"]:checked`);
                const correct = correctRadio ? correctRadio.value : null;
                const options = {};
                
                qDiv.querySelectorAll('.answer-option').forEach(opt => {
                    const letter = opt.dataset.option;
                    options[letter] = opt.value.trim();
                    if (opt.value.trim().length === 0) allOptionsValid = false;
                });
                
                if (questionText.length === 0 || !allOptionsValid || !correct) {
                    allOptionsValid = false;
                    return;
                }

                questions.push({ q: questionText, options: Object.values(options), correct: correct });
            });
            
            if (!allOptionsValid) {
                alert("Please ensure all question text, all options, and the correct answer are selected for every question.");
                return;
            }

            const newPost = {
                authorId: userId,
                content: content,
                media: media,
                category: category,
                likes: 0,
                authorRating: 4.0, // Initial rating
                timestamp: serverTimestamp(),
                exam: { questions: questions }
            };

            try {
                const postsRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily_learn_posts');
                await addDoc(postsRef, newPost);
                
                // Reset form and state
                document.getElementById('postForm').reset();
                examQuestionsContainer.innerHTML = generateQuestionTemplate(1);
                document.getElementById('addQuestionBtn').disabled = false;
                selectedMediaFile = null;
                handleFileSelection(null); // Update file info display
                
                closeModal(postModal);
            } catch (error) {
                console.error("Error creating post:", error);
                alert('Error posting lesson. Check console.');
            }
        });

        // --- FILTER LOGIC ---

        function renderFilterOptions() {
            filterOptions.innerHTML = '';
            CATEGORIES.forEach(category => {
                const btn = document.createElement('button');
                btn.textContent = category;
                btn.dataset.category = category;
                btn.classList.add('w-full', 'px-4', 'py-2', 'rounded-lg', 'font-semibold', 'transition', 'duration-150');
                if (category === currentFilter) {
                    btn.classList.add('bg-primary-dark', 'text-white', 'shadow-lg');
                    btn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                } else {
                    btn.classList.add('bg-blue-100', 'text-primary-dark', 'hover:bg-blue-200');
                    btn.classList.remove('bg-primary', 'text-white', 'shadow-md');
                }
                btn.addEventListener('click', () => {
                    currentFilter = category;
                    renderFeed();
                    closeModal(filterModal);
                });
                filterOptions.appendChild(btn);
            });
        }

        document.getElementById('filterBtn').addEventListener('click', () => {
            renderFilterOptions();
            openModal(filterModal);
        });
        document.getElementById('closeFilterModal').addEventListener('click', () => closeModal(filterModal));


        // --- EXAM LOGIC (LEARN -> EXAM FLOW) ---

        let activePost = null;

        function renderLessonContent(post) {
            modalTitle.textContent = `Lesson: ${post.category}`;
            const media = post.media;
            let contentHtml = '';

            if (media) {
                // Render Media
                const url = media.url || 'https://placehold.co/400x200/cccccc/000000?text=NO+FILE+STORAGE';
                if (media.type.startsWith('image/')) {
                    contentHtml = `<img src="${url}" onerror="this.onerror=null;this.src='${url}';" class="w-full h-auto object-cover rounded-lg shadow-md mb-4" alt="Post Image">`;
                } else if (media.type.startsWith('video/')) {
                    contentHtml = `<video src="${url}" controls class="w-full rounded-lg shadow-md mb-4" poster="https://placehold.co/400x200/cccccc/000000?text=VIDEO+CONTENT"></video>`;
                } else if (media.type.startsWith('audio/')) {
                    contentHtml = `<audio src="${url}" controls class="w-full rounded-lg shadow-md mb-4"></audio>`;
                } else {
                    contentHtml = `<div class="p-4 bg-gray-100 rounded-lg text-gray-700 font-medium">Media Type: ${media.type}. Full content: ${post.content}</div>`;
                }
            } else {
                // Render Text
                contentHtml = `<p class="text-gray-800 whitespace-pre-wrap">${post.content}</p>`;
            }

            lessonContentContainer.innerHTML = `
                <h3 class="text-lg font-bold text-primary-dark mb-2 border-b border-primary/20 pb-2">Category: ${post.category}</h3>
                ${contentHtml}
            `;
            lessonContentContainer.style.display = 'block';
            quizContainer.classList.add('hidden');
            startExamBtn.classList.remove('hidden');
            submitExamBtn.classList.add('hidden');
            document.getElementById('examResults').classList.add('hidden');
        }

        function renderQuizQuestions(post) {
            modalTitle.textContent = "Quick Quiz Time!";
            lessonContentContainer.style.display = 'none';
            quizContainer.classList.remove('hidden');
            startExamBtn.classList.add('hidden');
            submitExamBtn.classList.remove('hidden');
            document.getElementById('examResults').classList.add('hidden');

            const questionsHtml = post.exam.questions.map((q, qIndex) => `
                <div class="mb-5 p-3 border-b border-primary/10 bg-white shadow-sm rounded-lg">
                    <p class="font-bold text-gray-900 mb-3">Q${qIndex + 1}: ${q.q}</p>
                    ${q.options.map((opt, optIndex) => {
                        const optionLetter = LETTERS[optIndex]; // A, B, C
                        return `
                            <div class="flex items-center mb-2">
                                <input id="q${qIndex + 1}-opt${optionLetter}" type="radio" name="q${qIndex + 1}" data-question-index="${qIndex}" data-answer="${optionLetter}" class="w-4 h-4 text-primary focus:ring-primary border-gray-300">
                                <label for="q${qIndex + 1}-opt${optionLetter}" class="ml-2 text-sm font-medium text-gray-700">${optionLetter}. ${opt}</label>
                            </div>
                        `;
                    }).join('')}
                </div>
            `).join('');

            document.getElementById('examForm').innerHTML = questionsHtml;
        }


        function openExamModal(post) {
            activePost = post;
            renderLessonContent(post);
            openModal(examModal);
        }

        document.getElementById('startExamBtn').addEventListener('click', () => {
            if (activePost) {
                renderQuizQuestions(activePost);
            }
        });

        document.getElementById('submitExamBtn').addEventListener('click', async () => {
            const form = document.getElementById('examForm');
            const examResults = document.getElementById('examResults');
            const resultTitle = examResults.querySelector('p:first-child');
            const resultSummary = examResults.querySelector('p:last-child');

            const post = activePost;
            if (!post) return;

            let correctCount = 0;
            let totalQuestions = post.exam.questions.length;
            let isComplete = true;

            // Check answers
            post.exam.questions.forEach((q, qIndex) => {
                const radios = form.querySelectorAll(`input[name="q${qIndex + 1}"]`);
                const selected = Array.from(radios).find(r => r.checked);

                if (!selected) {
                    isComplete = false;
                } else if (selected.dataset.answer === q.correct) {
                    correctCount++;
                }
            });

            if (!isComplete) {
                resultTitle.textContent = "Oops!";
                resultSummary.textContent = "Please answer all questions before submitting.";
                examResults.className = 'mt-4 p-4 rounded-lg bg-red-100 text-red-800';
                examResults.classList.remove('hidden');
                setTimeout(() => examResults.classList.add('hidden'), 3000);
                return;
            }

            const passed = correctCount >= Math.ceil(totalQuestions / 2);
            const resultColor = passed ? 'bg-secondary/20 text-secondary' : 'bg-red-100 text-red-800';
            const resultText = passed ? 'Congratulations! You Passed.' : 'Better luck next time.';

            resultTitle.textContent = resultText;
            resultSummary.textContent = `You scored ${correctCount} out of ${totalQuestions} questions.`;
            examResults.className = `mt-4 p-4 rounded-lg ${resultColor}`;
            examResults.classList.remove('hidden');

            document.getElementById('submitExamBtn').classList.add('hidden');
            // document.getElementById('closeExamModal').classList.remove('hidden'); // Close button is always visible
            document.getElementById('likeBtn').disabled = false;
            document.getElementById('ratingBtn').disabled = false;

            // 2. Mark the post as viewed (Crucial "View Once" logic)
            if (isAuthReady && userId) {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'completed_exams', post.id);
                    await setDoc(docRef, {
                        postId: post.id,
                        completedAt: serverTimestamp(),
                        passed: passed
                    });
                    console.log(`Marked post ${post.id} as completed by user ${userId}`);
                } catch (error) {
                    console.error("Error marking exam complete:", error);
                }
            }
        });

        // --- LIKE / RATE LOGIC ---

        async function handleLikeRate(postId, action) {
            if (!isAuthReady || !userId) {
                alert('Authentication error. Cannot submit feedback.');
                return;
            }

            const postDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'daily_learn_posts', postId);

            if (action === 'like') {
                try {
                    const likeBtn = document.getElementById('likeBtn');
                    likeBtn.disabled = true;
                    likeBtn.textContent = 'Liked!';
                    await setDoc(postDocRef, { likes: (activePost.likes || 0) + 1 }, { merge: true });
                } catch (error) {
                    console.error("Error liking post:", error);
                }
            } else if (action === 'rate') {
                try {
                    const ratingBtn = document.getElementById('ratingBtn');
                    ratingBtn.disabled = true;
                    ratingBtn.textContent = 'Rated (5/5)';
                    // Mock: Set rating to 5.0 to represent a high score, boosting visibility
                    await setDoc(postDocRef, { authorRating: 5.0 }, { merge: true });
                } catch (error) {
                    console.error("Error rating post:", error);
                }
            }
        }
        document.getElementById('likeBtn').addEventListener('click', () => handleLikeRate(activePost.id, 'like'));
        document.getElementById('ratingBtn').addEventListener('click', () => handleLikeRate(activePost.id, 'rate'));

    </script>
</body>
</html>

