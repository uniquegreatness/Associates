<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cluster Administration Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .shadow-glow { box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
    </style>
    <script>
        const SUPABASE_URL = '__SUPABASE_URL_INJECTION__';
        const SUPABASE_ANON_KEY = '__SUPABASE_ANON_KEY_INJECTION__';
        // Add redirect script here if the server setup requires it
    </script>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div id="login-container" class="max-w-md mx-auto mt-16 p-8 bg-white rounded-xl shadow-2xl transition duration-500">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Admin Login</h2>
        <form id="login-form">
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                <input type="email" id="email" name="email" required 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                       placeholder="admin@yourdomain.com">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <input type="password" id="password" name="password" required 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                       placeholder="Enter password">
            </div>
            <button type="submit" id="login-button"
                    class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 shadow-md hover:shadow-lg">
                Login
            </button>
            <a href="/login.html#forgot" class="block mt-4 text-sm text-center text-blue-600 hover:text-blue-800 transition duration-150">
                Forgot Password?
            </a>
            <div id="login-message" class="mt-4 text-center text-red-500 text-sm hidden"></div>
        </form>
    </div>
    
    <div id="admin-container" class="max-w-6xl mx-auto hidden">
        
        <header class="mb-8 p-4 bg-white rounded-xl shadow-md flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-gray-900">Cluster Management</h1>
            <button id="logout-button" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition duration-150">
                Logout
            </button>
        </header>

        <div class="bg-white shadow-xl rounded-xl p-6 mb-8 border border-blue-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Create New Cluster</h2>
            <form id="create-cluster-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Cluster Name</label>
                    <input type="text" id="name" name="name" required placeholder="e.g., North America Prod 1"
                           class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="region" class="block text-sm font-medium text-gray-700">Region</label>
                    <input type="text" id="region" name="region" required placeholder="e.g., California"
                           class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="capacity" class="block text-sm font-medium text-gray-700">Capacity (Units)</label>
                    <input type="number" id="capacity" name="capacity" required min="1" placeholder="e.g., 5000"
                           class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" 
                        class="w-full h-10 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150 shadow-md">
                    + Add Cluster
                </button>
            </form>
            <div id="create-message" class="mt-4 text-sm hidden"></div>
        </div>

        <div class="bg-white shadow-xl rounded-xl overflow-hidden border border-gray-200">
            <div class="p-4 bg-gray-50 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700">Existing Clusters</h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Region</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Capacity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clusters-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="6" class="p-4 text-center text-gray-400">Loading clusters...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Edit Cluster <span id="modal-cluster-id" class="text-blue-600"></span></h3>
                <form id="edit-cluster-form">
                    <input type="hidden" id="edit-id">
                    <div class="mb-4">
                        <label for="edit-name" class="block text-sm font-medium text-gray-700">Cluster Name</label>
                        <input type="text" id="edit-name" name="name" required
                               class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="edit-region" class="block text-sm font-medium text-gray-700">Region</label>
                        <input type="text" id="edit-region" name="region" required
                               class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="edit-capacity" class="block text-sm font-medium text-gray-700">Capacity (Units)</label>
                        <input type="number" id="edit-capacity" name="capacity" required min="1"
                               class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="edit-message" class="mb-4 text-sm hidden"></div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="close-modal" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // NOTE: SUPABASE_URL and SUPABASE_ANON_KEY are injected by server.js
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- CONSTANTS AND DOM ELEMENTS ---
        const loginContainer = document.getElementById('login-container');
        const adminContainer = document.getElementById('admin-container');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const createForm = document.getElementById('create-cluster-form');
        const clustersBody = document.getElementById('clusters-body');
        const createMessageDiv = document.getElementById('create-message');
        const loginMessageDiv = document.getElementById('login-message');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-cluster-form');
        const editMessageDiv = document.getElementById('edit-message');

        let adminAccessToken = sessionStorage.getItem('adminAccessToken') || null;

        // --- UTILITY FUNCTIONS ---

        /**
         * Generic fetcher function for Admin API calls with Authorization header.
         * @param {string} endpoint - API path.
         * @param {string} method - HTTP method (GET, POST, PUT, DELETE).
         * @param {object} [body] - Data to send with POST/PUT requests.
         * @returns {Promise<object>} The JSON response body.
         */
        async function adminFetch(endpoint, method = 'GET', body = null) {
            if (!adminAccessToken) {
                // Should not happen if checkAuth runs correctly, but as a safety net
                console.error('Admin token missing. Logging out.');
                logout();
                throw new Error('Unauthorized: Admin token missing.');
            }
            
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminAccessToken}`
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(endpoint, options);
            const data = await response.json();

            if (response.status === 401 || response.status === 403) {
                 // Unauthorized or Forbidden (token expired, role revoked)
                 logout();
                 throw new Error(data.message || 'Authentication failed. Please log in again.');
            }

            if (!response.ok) {
                throw new Error(data.message || `API error (${response.status})`);
            }

            return data;
        }

        /**
         * Renders the cluster table rows with dynamic content and action buttons.
         * @param {Array<object>} clusters - Array of cluster objects from the API.
         */
        const renderClusters = (clusters) => {
            clustersBody.innerHTML = ''; 
            
            if (clusters.length === 0) {
                 clustersBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No clusters currently configured.</td></tr>';
                 return;
            }

            clusters.forEach(cluster => {
                const statusColor = cluster.active_cohort_id ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
                const statusText = cluster.active_cohort_id ? 'In Use' : 'Open';
                
                clustersBody.innerHTML += `
                    <tr class="hover:bg-blue-50 transition duration-100">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${cluster.cluster_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${cluster.cluster_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cluster.cluster_region}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cluster.max_members.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${cluster.cluster_id}" data-name="${cluster.cluster_name}" data-region="${cluster.cluster_region}" data-capacity="${cluster.max_members}"
                                class="edit-btn text-blue-600 hover:text-blue-900 mr-3 transition duration-150">Edit</button>
                            <button onclick="deleteCluster(${cluster.cluster_id})" class="text-red-600 hover:text-red-900 transition duration-150">Delete</button>
                        </td>
                    </tr>
                `;
            });
            // Attach event listeners to the new Edit buttons
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', openEditModal);
            });
        };

        // --- CRUD ACTIONS ---

        /**
         * READ: Fetches and renders all clusters.
         */
        const loadClusters = async () => {
            clustersBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-blue-500">Fetching cluster data...</td></tr>';
            
            try {
                const data = await adminFetch('/api/admin/clusters', 'GET');
                renderClusters(data.clusters);
            } catch (error) {
                console.error('Error fetching clusters:', error.message);
                clustersBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Failed to load clusters: ${error.message}</td></tr>`;
            }
        };

        /**
         * CREATE: Handles the creation of a new cluster.
         */
        const handleCreateCluster = async (e) => {
            e.preventDefault();
            const formData = new FormData(createForm);
            const name = formData.get('name');
            const region = formData.get('region');
            const capacity = formData.get('capacity');
            
            createMessageDiv.textContent = 'Creating cluster...';
            createMessageDiv.className = 'mt-4 text-sm text-yellow-600 block';
            
            try {
                const response = await adminFetch('/api/admin/clusters', 'POST', {
                    cluster_name: name,
                    cluster_region: region,
                    max_members: capacity
                });
                
                createMessageDiv.textContent = `Success: Cluster ${response.cluster.cluster_id} created.`;
                createMessageDiv.classList.remove('text-yellow-600');
                createMessageDiv.classList.add('text-green-600');
                createForm.reset();
                loadClusters(); // Reload table
            } catch (error) {
                createMessageDiv.textContent = `Error: ${error.message}`;
                createMessageDiv.classList.remove('text-yellow-600');
                createMessageDiv.classList.add('text-red-600');
            } finally {
                setTimeout(() => { createMessageDiv.classList.add('hidden'); }, 3000);
            }
        };

        /**
         * DELETE: Handles the deletion of a cluster.
         * @param {number} id - The ID of the cluster to delete.
         */
        window.deleteCluster = async (id) => {
            if (!confirm(`Are you sure you want to permanently delete Cluster ID ${id}? This cannot be undone.`)) {
                return;
            }

            clustersBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Deleting cluster ${id}...</td></tr>` + clustersBody.innerHTML;
            
            try {
                await adminFetch(`/api/admin/clusters/${id}`, 'DELETE');
                alert(`Cluster ${id} successfully deleted.`);
                loadClusters(); // Reload table
            } catch (error) {
                alert(`Failed to delete cluster ${id}: ${error.message}`);
                loadClusters(); // Reload table to show current state
            }
        };
        
        // --- UPDATE (EDIT) LOGIC ---
        
        /**
         * Opens the edit modal and populates it with cluster data.
         */
        function openEditModal(e) {
            const button = e.currentTarget;
            const id = button.getAttribute('data-id');
            const name = button.getAttribute('data-name');
            const region = button.getAttribute('data-region');
            const capacity = button.getAttribute('data-capacity');

            document.getElementById('edit-id').value = id;
            document.getElementById('modal-cluster-id').textContent = id;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-region').value = region;
            document.getElementById('edit-capacity').value = capacity;
            editMessageDiv.classList.add('hidden');
            editModal.classList.remove('hidden');
        }

        /**
         * Closes the edit modal.
         */
        function closeEditModal() {
            editModal.classList.add('hidden');
        }

        /**
         * UPDATE: Handles the form submission for editing a cluster.
         */
        const handleEditCluster = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value;
            const region = document.getElementById('edit-region').value;
            const capacity = document.getElementById('edit-capacity').value;
            
            editMessageDiv.textContent = 'Saving changes...';
            editMessageDiv.className = 'mt-4 text-sm text-yellow-600 block';

            try {
                await adminFetch(`/api/admin/clusters/${id}`, 'PUT', {
                    cluster_name: name,
                    cluster_region: region,
                    max_members: capacity
                });

                editMessageDiv.textContent = 'Changes saved successfully!';
                editMessageDiv.classList.remove('text-yellow-600', 'text-red-600');
                editMessageDiv.classList.add('text-green-600');
                
                // Delay closing the modal to let user see success message
                setTimeout(() => {
                    closeEditModal();
                    loadClusters(); // Reload table
                }, 1000);

            } catch (error) {
                editMessageDiv.textContent = `Error: ${error.message}`;
                editMessageDiv.classList.remove('text-yellow-600', 'text-green-600');
                editMessageDiv.classList.add('text-red-600');
            }
        };

        // --- AUTHENTICATION HANDLERS ---

        /**
         * Handles the admin login process.
         */
        const handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            loginMessageDiv.textContent = 'Logging in...';
            loginMessageDiv.className = 'mt-4 text-center text-blue-500 text-sm block';
            
            try {
                // Call your custom secure admin login endpoint
                const response = await fetch('/api/admin-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok || !data.success || !data.access_token) {
                    throw new Error(data.message || 'Login failed: Invalid credentials or not an admin.');
                }
                
                // Store the access token for secure API calls
                adminAccessToken = data.access_token;
                sessionStorage.setItem('adminAccessToken', adminAccessToken);
                
                // Use a simple flag for quick session check
                sessionStorage.setItem('adminLoggedIn', 'true'); 
                
                checkAuth(); // Switch to admin panel
            } catch (error) {
                loginMessageDiv.textContent = error.message;
                loginMessageDiv.classList.remove('text-blue-500');
                loginMessageDiv.classList.add('text-red-500');
            }
        };
        
        /**
         * Handles admin logout.
         */
        const logout = async () => {
            // Optional: Call Supabase sign out if you want to clear client-side session cookies too
            await supabase.auth.signOut(); 
            
            // Clear local session state
            sessionStorage.removeItem('adminAccessToken');
            sessionStorage.removeItem('adminLoggedIn');
            adminAccessToken = null;
            
            checkAuth(); // Switch back to login panel
        };

        /**
         * Checks the current authentication status and updates the UI.
         */
        const checkAuth = () => {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true' && adminAccessToken;

            if (isLoggedIn) {
                loginContainer.classList.add('hidden');
                adminContainer.classList.remove('hidden');
                loadClusters(); // Fetch data when admin panel is shown
            } else {
                loginContainer.classList.remove('hidden');
                adminContainer.classList.add('hidden');
                loginForm.reset();
                loginMessageDiv.classList.add('hidden');
            }
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Event Listeners
            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', logout);
            createForm.addEventListener('submit', handleCreateCluster);
            editForm.addEventListener('submit', handleEditCluster);
            document.getElementById('close-modal').addEventListener('click', closeEditModal);

            // Check authentication on load
            checkAuth();
        });
    </script>
</body>
</html>