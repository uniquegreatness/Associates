<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cluster Administration Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .shadow-glow { box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        /* CSS to ensure views are hidden/shown correctly */
        .hidden-view { display: none; }
    </style>
    <script>
        const SUPABASE_URL = '__SUPABASE_URL_INJECTION__';
        const SUPABASE_ANON_KEY = '__SUPABASE_ANON_KEY_INJECTION__';
    </script>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div id="login-wrapper" class="max-w-md mx-auto mt-16 p-8 bg-white rounded-xl shadow-2xl transition duration-500">
        
        <div id="loginView">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Admin Login</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                    <input type="email" id="email" name="email" required 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                           placeholder="admin@yourdomain.com">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" name="password" required 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                           placeholder="Enter password">
                </div>
                <button type="submit" id="login-button"
                        class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 shadow-md hover:shadow-lg">
                    Login
                </button>
                <a href="#" id="forgot-link" class="block mt-4 text-sm text-center text-blue-600 hover:text-blue-800 transition duration-150">
                    Forgot Password?
                </a>
                <div id="login-message" class="mt-4 text-center text-red-500 text-sm hidden"></div>
            </form>
        </div>
        
        <div id="forgotView" class="hidden-view">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Reset Password</h2>
            <p class="text-gray-600 mb-4">Enter your admin email address to receive a password reset link.</p>
            
            <form id="forgotPasswordForm">
                <div class="space-y-4">
                    <div>
                        <label for="resetEmail" class="block text-sm font-semibold text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="resetEmail" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                               placeholder="admin@yourdomain.com">
                    </div>

                    <button type="submit" id="resetButton"
                            class="w-full py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-lg text-lg transition duration-200 shadow-md">
                        Send Reset Link
                    </button>
                    
                    <button type="button" onclick="showView('login')"
                            class="w-full py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-lg text-lg transition duration-200">
                        Back to Login
                    </button>
                </div>
            </form>
            <div id="reset-message" class="mt-4 text-center text-sm hidden"></div>
        </div>
        
    </div>
    
    <div id="admin-container" class="max-w-6xl mx-auto hidden">
        
        <header class="mb-8 p-4 bg-white rounded-xl shadow-md flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-gray-900">Cluster Management</h1>
            <button id="logout-button" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition duration-150">
                Logout
            </button>
        </header>

        <div class="bg-white shadow-xl rounded-xl p-6 mb-8 border border-blue-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Create New Cluster</h2>
            <form id="create-cluster-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Cluster Name</label>
                    <input type="text" id="name" name="name" required placeholder="e.g., North America Prod 1"
                           class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="region" class="block text-sm font-medium text-gray-700">Region</label>
                    <input type="text" id="region" name="region" required placeholder="e.g., California"
                           class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="capacity" class="block text-sm font-medium text-gray-700">Capacity (Units)</label>
                    <input type="number" id="capacity" name="capacity" required min="1" placeholder="e.g., 5000"
                           class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" 
                        class="w-full h-10 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150 shadow-md">
                    + Add Cluster
                </button>
            </form>
            <div id="create-message" class="mt-4 text-sm hidden"></div>
        </div>

        <div class="bg-white shadow-xl rounded-xl overflow-hidden border border-gray-200">
            <div class="p-4 bg-gray-50 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700">Existing Clusters</h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Region</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Capacity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clusters-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="6" class="p-4 text-center text-gray-400">Loading clusters...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Edit Cluster <span id="modal-cluster-id" class="text-blue-600"></span></h3>
                <form id="edit-cluster-form">
                    <input type="hidden" id="edit-id">
                    <div class="mb-4">
                        <label for="edit-name" class="block text-sm font-medium text-gray-700">Cluster Name</label>
                        <input type="text" id="edit-name" name="name" required
                               class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="edit-region" class="block text-sm font-medium text-gray-700">Region</label>
                        <input type="text" id="edit-region" name="region" required
                               class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="edit-capacity" class="block text-sm font-medium text-gray-700">Capacity (Units)</label>
                        <input type="number" id="edit-capacity" name="capacity" required min="1"
                               class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="edit-message" class="mb-4 text-sm hidden"></div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="close-modal" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // NOTE: SUPABASE_URL and SUPABASE_ANON_KEY are injected by server.js
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- CONSTANTS AND DOM ELEMENTS ---
        const loginWrapper = document.getElementById('login-wrapper');
        const loginView = document.getElementById('loginView');
        const forgotView = document.getElementById('forgotView');
        const adminContainer = document.getElementById('admin-container');
        const loginForm = document.getElementById('login-form');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm'); 
        const forgotLink = document.getElementById('forgot-link'); // Added DOM element for the link
        const logoutButton = document.getElementById('logout-button');
        const createForm = document.getElementById('create-cluster-form');
        const clustersBody = document.getElementById('clusters-body');
        const createMessageDiv = document.getElementById('create-message');
        const loginMessageDiv = document.getElementById('login-message');
        const resetMessageDiv = document.getElementById('reset-message'); 
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-cluster-form');
        const editMessageDiv = document.getElementById('edit-message');
        const emailInput = document.getElementById('email');
        const resetEmailInput = document.getElementById('resetEmail'); 
        const resetButton = document.getElementById('resetButton'); 

        let adminAccessToken = sessionStorage.getItem('adminAccessToken') || null;
        
        // --- VIEW SWITCHING UTILITY ---
        
        /**
         * Switches the active view (Login or Forgot Password).
         * @param {'login' | 'forgot'} viewName 
         */
        function showView(viewName) {
            // Because showView is inside a module, we make it a global function 
            // by assigning it to the window object if we wanted to keep the inline onclick,
            // but the preferred modern way (which we are using) is to attach an event listener.
            
            loginMessageDiv.classList.add('hidden');
            resetMessageDiv.classList.add('hidden');

            if (viewName === 'login') {
                forgotView.classList.add('hidden-view');
                loginView.classList.remove('hidden-view');
            } else if (viewName === 'forgot') {
                loginView.classList.add('hidden-view');
                forgotView.classList.remove('hidden-view');
                
                // Pre-populate reset email if login email was filled
                if (emailInput.value) {
                    resetEmailInput.value = emailInput.value;
                }
            }
        }
        
        /**
         * Utility function to display messages for login/reset
         */
        function displayMessage(divElement, text, isError = false) {
            divElement.textContent = text;
            divElement.classList.remove('hidden', 'text-red-500', 'text-green-600', 'text-blue-500', 'text-yellow-600');
            
            if (isError) {
                divElement.classList.add('text-red-500');
                console.error(`UI Message (Error): ${text}`);
            } else {
                divElement.classList.add('text-green-600');
                console.log(`UI Message (Info): ${text}`);
            }
            divElement.classList.remove('hidden');
        }

        // --- CRUD/FETCH UTILITY FUNCTIONS (Unchanged) ---
        // ... (adminFetch, renderClusters, loadClusters, handleCreateCluster, deleteCluster, openEditModal, closeEditModal, handleEditCluster remain the same) ...
        
        async function adminFetch(endpoint, method = 'GET', body = null) {
            if (!adminAccessToken) {
                console.error('Admin token missing. Logging out.');
                logout();
                throw new Error('Unauthorized: Admin token missing.');
            }
            
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminAccessToken}`
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(endpoint, options);
            const data = await response.json();

            if (response.status === 401 || response.status === 403) {
                 logout();
                 throw new Error(data.message || 'Authentication failed. Please log in again.');
            }

            if (!response.ok) {
                throw new Error(data.message || `API error (${response.status})`);
            }

            return data;
        }

        const renderClusters = (clusters) => {
            clustersBody.innerHTML = ''; 
            
            if (clusters.length === 0) {
                 clustersBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No clusters currently configured.</td></tr>';
                 return;
            }

            clusters.forEach(cluster => {
                const statusColor = cluster.active_cohort_id ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
                const statusText = cluster.active_cohort_id ? 'In Use' : 'Open';
                
                clustersBody.innerHTML += `
                    <tr class="hover:bg-blue-50 transition duration-100">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${cluster.cluster_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${cluster.cluster_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cluster.cluster_region}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cluster.max_members.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${cluster.cluster_id}" data-name="${cluster.cluster_name}" data-region="${cluster.cluster_region}" data-capacity="${cluster.max_members}"
                                class="edit-btn text-blue-600 hover:text-blue-900 mr-3 transition duration-150">Edit</button>
                            <button onclick="deleteCluster(${cluster.cluster_id})" class="text-red-600 hover:text-red-900 transition duration-150">Delete</button>
                        </td>
                    </tr>
                `;
            });
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', openEditModal);
            });
        };

        const loadClusters = async () => {
            clustersBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-blue-500">Fetching cluster data...</td></tr>';
            
            try {
                const data = await adminFetch('/api/admin/clusters', 'GET');
                renderClusters(data.clusters);
            } catch (error) {
                console.error('Error fetching clusters:', error.message);
                clustersBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Failed to load clusters: ${error.message}</td></tr>`;
            }
        };

        const handleCreateCluster = async (e) => {
            e.preventDefault();
            const formData = new FormData(createForm);
            const name = formData.get('name');
            const region = formData.get('region');
            const capacity = formData.get('capacity');
            
            createMessageDiv.textContent = 'Creating cluster...';
            createMessageDiv.className = 'mt-4 text-sm text-yellow-600 block';
            
            try {
                const response = await adminFetch('/api/admin/clusters', 'POST', {
                    cluster_name: name,
                    cluster_region: region,
                    max_members: capacity
                });
                
                createMessageDiv.textContent = `Success: Cluster ${response.cluster.cluster_id} created.`;
                createMessageDiv.classList.remove('text-yellow-600');
                createMessageDiv.classList.add('text-green-600');
                createForm.reset();
                loadClusters();
            } catch (error) {
                createMessageDiv.textContent = `Error: ${error.message}`;
                createMessageDiv.classList.remove('text-yellow-600');
                createMessageDiv.classList.add('text-red-600');
            } finally {
                setTimeout(() => { createMessageDiv.classList.add('hidden'); }, 3000);
            }
        };

        window.deleteCluster = async (id) => {
            if (!confirm(`Are you sure you want to permanently delete Cluster ID ${id}? This cannot be undone.`)) {
                return;
            }

            clustersBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Deleting cluster ${id}...</td></tr>` + clustersBody.innerHTML;
            
            try {
                await adminFetch(`/api/admin/clusters/${id}`, 'DELETE');
                alert(`Cluster ${id} successfully deleted.`);
                loadClusters();
            } catch (error) {
                alert(`Failed to delete cluster ${id}: ${error.message}`);
                loadClusters();
            }
        };
        
        function openEditModal(e) {
            const button = e.currentTarget;
            const id = button.getAttribute('data-id');
            const name = button.getAttribute('data-name');
            const region = button.getAttribute('data-region');
            const capacity = button.getAttribute('data-capacity');

            document.getElementById('edit-id').value = id;
            document.getElementById('modal-cluster-id').textContent = id;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-region').value = region;
            document.getElementById('edit-capacity').value = capacity;
            editMessageDiv.classList.add('hidden');
            editModal.classList.remove('hidden');
        }

        function closeEditModal() {
            editModal.classList.add('hidden');
        }

        const handleEditCluster = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value;
            const region = document.getElementById('edit-region').value;
            const capacity = document.getElementById('edit-capacity').value;
            
            editMessageDiv.textContent = 'Saving changes...';
            editMessageDiv.className = 'mt-4 text-sm text-yellow-600 block';

            try {
                await adminFetch(`/api/admin/clusters/${id}`, 'PUT', {
                    cluster_name: name,
                    cluster_region: region,
                    max_members: capacity
                });

                editMessageDiv.textContent = 'Changes saved successfully!';
                editMessageDiv.classList.remove('text-yellow-600', 'text-red-600');
                editMessageDiv.classList.add('text-green-600');
                
                setTimeout(() => {
                    closeEditModal();
                    loadClusters();
                }, 1000);

            } catch (error) {
                editMessageDiv.textContent = `Error: ${error.message}`;
                editMessageDiv.classList.remove('text-yellow-600', 'text-green-600');
                editMessageDiv.classList.add('text-red-600');
            }
        };
        
        // --- AUTHENTICATION HANDLERS ---

        /**
         * Handles the admin login process.
         */
        const handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            displayMessage(loginMessageDiv, 'Logging in...', false);

            try {
                // Call your custom secure admin login endpoint
                const response = await fetch('/api/admin-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok || !data.success || !data.access_token) {
                    throw new Error(data.message || 'Login failed: Invalid credentials or not an admin.');
                }
                
                adminAccessToken = data.access_token;
                sessionStorage.setItem('adminAccessToken', adminAccessToken);
                sessionStorage.setItem('adminLoggedIn', 'true'); 
                
                checkAuth();
            } catch (error) {
                displayMessage(loginMessageDiv, error.message, true);
            }
        };
        
        /**
         * Handles the FORGOT PASSWORD form submission.
         */
        async function handlePasswordReset(event) {
            event.preventDefault();
            const email = resetEmailInput.value;

            if (!email) {
                displayMessage(resetMessageDiv, 'Please enter your email address.', true);
                return;
            }

            if (!supabase) {
                displayMessage(resetMessageDiv, 'Supabase service is not available.', true);
                return;
            }

            console.log('Attempting password reset for:', email);
            resetButton.disabled = true;
            resetButton.textContent = 'Sending...';
            displayMessage(resetMessageDiv, 'Sending password reset link...', false);

            // Set redirectTo to the new page where the user will update their password
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                // Assuming you use the same update-password page for admin users
                redirectTo: `${window.location.origin}/update-password.html` 
            });

            if (error) {
                console.error('Password Reset Supabase Error:', error);
            }
            
            // Display secure success message whether the user exists or not
            displayMessage(resetMessageDiv, `If an admin account is registered with ${email}, a password reset link has been sent to your inbox.`, false);
            
            resetButton.disabled = false;
            resetButton.textContent = 'Send Reset Link';
        }

        /**
         * Handles admin logout.
         */
        const logout = async () => {
            await supabase.auth.signOut(); 
            
            sessionStorage.removeItem('adminAccessToken');
            sessionStorage.removeItem('adminLoggedIn');
            adminAccessToken = null;
            
            checkAuth(); 
        };

        /**
         * Checks the current authentication status and updates the UI.
         */
        const checkAuth = () => {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true' && adminAccessToken;

            if (isLoggedIn) {
                loginWrapper.classList.add('hidden'); // Hide the entire login/forgot container
                adminContainer.classList.remove('hidden');
                loadClusters();
            } else {
                loginWrapper.classList.remove('hidden'); // Show the entire login/forgot container
                adminContainer.classList.add('hidden');
                loginForm.reset();
                showView('login'); // Ensure we default back to the login view
            }
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Event Listeners
            loginForm.addEventListener('submit', handleLogin);
            forgotPasswordForm.addEventListener('submit', handlePasswordReset); 
            
            // FIX: Attach the event listener for the "Forgot Password?" link using the element ID
            if (forgotLink) {
                forgotLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showView('forgot');
                });
            }

            logoutButton.addEventListener('click', logout);
            createForm.addEventListener('submit', handleCreateCluster);
            editForm.addEventListener('submit', handleEditCluster);
            document.getElementById('close-modal').addEventListener('click', closeEditModal);

            // Make showView globally accessible for the inline onclick on the "Back to Login" button in forgotView
            window.showView = showView;

            // Check authentication on load
            checkAuth();
        });
    </script>
</body>
</html>