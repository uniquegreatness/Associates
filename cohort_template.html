<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interest Cluster Contact Exchange</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase client load -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Lucide Icons for UI -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Define the primary color palette based on a bright blue */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        :root {
            --primary-blue: #3b82f6; /* Tailwind blue-500 */
            --light-blue: #eff6ff; /* Tailwind blue-50 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-blue);
            color: #1f2937; /* Dark text for high contrast */
        }
        .card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px rgba(59, 130, 246, 0.15);
        }
        /* Style for highlighted referral card */
        .card-highlight {
            border: 2px solid #f59e0b; /* Amber/Yellow border */
            transform: scale(1.02);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }
        .join-btn {
            background-color: var(--primary-blue);
            transition: background-color 0.2s ease;
        }
        .join-btn:hover {
            background-color: #2563eb; /* Tailwind blue-600 */
        }
        .full-btn {
            background-color: #6b7280; /* Tailwind gray-500 */
            cursor: not-allowed;
            opacity: 0.8;
        }
        .login-prompt-btn {
            background-color: #f59e0b; /* Tailwind amber-500 */
            transition: background-color 0.2s ease;
        }
        .login-prompt-btn:hover {
             background-color: #d97706; /* Tailwind amber-600 */
        }
        /* Ensure the clamp works for card descriptions */
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;  
            overflow: hidden;
        }
        .download-btn {
            background-color: #10b981; /* Tailwind emerald-500 */
            transition: background-color 0.2s ease;
        }
        .download-btn:hover {
            background-color: #059669; /* Tailwind emerald-600 */
        }
        /* Custom class for the Member Action Button container */
        .member-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* 3 buttons for now */
            gap: 8px;
        }
        .action-btn {
            padding: 8px 10px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        /* Styling for the new member action buttons */
        .share-btn { background-color: #f59e0b; color: white; }
        .share-btn:hover { background-color: #d97706; }
        .stats-btn { background-color: #3b82f6; color: white; }
        .stats-btn:hover { background-color: #2563eb; }
    </style>
</head>
<body class="min-h-screen pb-4">

    <!-- Notification/Error Message Container (Replaces alert()) -->
    <div id="notificationArea" class="fixed top-4 right-4 z-50 w-full max-w-xs space-y-2">
        <!-- Messages will be injected here -->
    </div>

    <!-- Header / Navigation Bar -->
    <header class="bg-white shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-2xl font-bold text-blue-600">NEAR Network</h1>
                <nav>
                    <!-- Nav content placeholder -->
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        <h2 class="text-4xl font-extrabold text-gray-900 mb-4 text-center">
            Find Your Cohort
        </h2>
        <p class="text-center text-lg text-gray-500 mb-10 max-w-3xl mx-auto">
            Join a cluster and connect mutually with 5 others who share your interests. Your contact details will only be exchanged once the cohort is full.
        </p>
        
        <!-- Cards Grid -->
        <div id="clusterGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Cards will be dynamically inserted here by JavaScript -->
        </div>
    </main>
    
    <!-- Modal 1: VCF Join Input (Existing Modal) -->
    <div id="inputModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 space-y-6">
            <h3 class="text-2xl font-bold text-gray-800 border-b pb-3">Final Step: Define Your VCF Display</h3>
            
            <form id="contactForm">
                <input type="hidden" id="modalClusterId">
                
                <p class="text-sm text-gray-500 mb-4">
                    Your profile data (Nickname, Profession, WhatsApp) will be fetched from the **`user_profiles`** table by the server. Please confirm how your name should appear in the shared contact file:
                </p>

                <div class="flex items-start p-4 border rounded-lg bg-blue-50">
                    <div class="flex items-center h-5">
                        <input id="displayProfession" type="checkbox" checked class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="displayProfession" class="font-bold text-gray-800">Display my Profession</label>
                        <p class="text-gray-600 mt-1">
                            <span class="font-semibold">Checked:</span> Name will be **[Nickname (Profession)]**.<br>
                            <span class="font-semibold">Unchecked:</span> Name will be **[Nickname NEARR]** (Note the space).
                        </p>
                    </div>
                </div>

                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="closeModal('inputModal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                        Cancel
                    </button>
                    <button type="submit" class="join-btn px-4 py-2 text-sm font-medium text-white rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Confirm Join Cluster
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal 2: Statistics and Member List View (NEW) -->
    <div id="statsModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                <h3 class="text-2xl font-bold text-gray-800" id="statsModalTitle">Cluster Statistics: Loading...</h3>
            </div>
            
            <div class="p-6 overflow-y-auto flex-grow">
                <div id="statsModalContent" class="space-y-6">
                    <!-- Statistics Summary -->
                    <div id="statsSummary" class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-lg mb-2 text-blue-600">Demographic Overview</h4>
                        <div id="statsPlaceholder" class="text-gray-500">
                            Loading statistical data...
                        </div>
                        <ul id="statsList" class="space-y-1 text-sm hidden">
                            <!-- Stats (e.g., Average Age, Country Distribution) will be here -->
                        </ul>
                    </div>
                    
                    <!-- Member List (Filtered Profiles) -->
                    <div>
                        <h4 class="font-semibold text-lg mb-2 text-gray-800">Current Members (<span id="memberCount">0</span>/<span id="maxCount">${MAX_COHORT_SIZE}</span>)</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nickname</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Country</th>
                                    </tr>
                                </thead>
                                <tbody id="memberTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Member rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                        <p id="memberLoading" class="text-center text-sm text-gray-500 mt-4">Loading member list...</p>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t flex justify-end">
                <button type="button" onclick="closeModal('statsModal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Script Block -->
    <script>
        // --- 1. CONFIGURATION AND DATA ---

        // Global variables provided by the environment (required for Supabase integration)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // These keys are expected to be injected by the hosting environment
        const supabaseUrl = '__SUPABASE_URL_INJECTION__';
        const supabaseAnonKey = '__SUPABASE_ANON_KEY_INJECTION__';

        let supabase; // Global instance for the client
        let userId = null;
        let userReferralCode = 'MOCK_USER_REF_1234'; // MOCK: Must be fetched from user_profiles table later
        let isAuthReady = false; // Tracks if the initial Supabase session check is complete

        // The Fixed Capacity Cohort Size 
        const MAX_COHORT_SIZE = 5;
        
        // ** STATE TRACKING **
        // Tracks user's membership status for quick access: { cluster_id: { ..., user_is_member: true } }
        let userClusterMemberships = {}; 
        // Tracks the overall cohort status: { cluster_id: { cohort_id: 'C_1_2', is_full: false, current_members: 3, vcf_uploaded: false, vcf_file_name: null } }
        let clusterStatusCache = {}; 
        
        // ** REFERRAL STATE TRACKING **
        let highlightedClusterId = null; // Cluster ID from referral link, used for UI highlight

        // Mock data for the 10 categories
        const categories = [
            { id: 1, name: "Personality Archetypes", details: "Groups people by how they think, socialize, and make decisions. Examples: analytical thinkers, creatives, explorers, nurturers, leaders." },
            { id: 2, name: "Life Goals & Ambitions", details: "Connect people who are trying to achieve similar things. Examples: career growth, building wealth, self-improvement, spirituality, building a family, entrepreneurship." },
            { id: 3, name: "Core Values", details: "Match people who share similar moral anchors. Examples: honesty, ambition, loyalty, freedom, tradition, creativity, fairness." },
            { id: 4, name: "Social Energy & Interaction Style", details: "Helps users find people they vibe with socially. Examples: extroverts, introverts, ambiverts, deep conversationalists, social butterflies." },
            { id: 5, name: "Hobbies & Personal Interests", details: "This is one of the strongest bonding categories. Examples: gaming, fitness, cooking, music, movies, travel, tech, art, books." },
            { id: 6, name: "Work & Professional Lifestyle", details: "Groups people with similar work rhythms and environments. Examples: remote workers, creatives, entrepreneurs, students, tech professionals, business people." },
            { id: 7, name: "Emotional & Relational Style", details: "Helps people find others who communicate in similar ways. Examples: peace-lovers, problem-solvers, deep feelers, logical communicators, supportive helpers." },
            { id: 8, name: "Growth & Learning Preferences", details: "People who pursue self-development in similar ways. Examples: readers, podcast listeners, course takers, experimenters, mentors and mentees." },
            { id: 9, name: "Lifestyle & Daily Habits", details: "Connects people with compatible lifestyles. Examples: early birds, night owls, fitness-focused, minimalists, adventurers, homebodies." },
            { id: 10, name: "Worldview & Philosophy Type", details: "People bond when they see life in similar ways. Examples: realists, dreamers, optimists, analysts, spiritualists, humanitarians." }
        ];
        
        // --- 2. UI MANIPULATION AND HELPERS ---

        /**
         * Redirects the user to the login page, saving the current page as the intended destination.
         */
        function redirectToLogin() {
            // Save the current full URL (path + query parameters) before redirecting
            sessionStorage.setItem('intended_destination', window.location.pathname + window.location.search);
            console.log(`Saved intended destination to: ${sessionStorage.getItem('intended_destination')}`);

            showNotification("You must be logged in to join or download contacts. Redirecting to login...", 'info');
            
            // Wait a moment for the user to read the message, then redirect
            setTimeout(() => {
                window.location.href = '/login.html';
            }, 1500);
        }

        /**
         * Displays a notification message.
         * @param {string} message - The message content.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        function showNotification(message, type) {
            const area = document.getElementById('notificationArea');
            const colorMap = {
                'success': { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-400' },
                'error': { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-400' },
                'info': { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-400' },
            };
            const colors = colorMap[type] || colorMap['info'];

            const notification = document.createElement('div');
            notification.className = `${colors.bg} ${colors.text} p-4 rounded-lg border-l-4 ${colors.border} shadow-lg transition-opacity duration-300`;
            notification.textContent = message;

            area.prepend(notification);
            
            if (type === 'error') {
                console.error(`UI Notification (Error): ${message}`);
            } else if (type === 'info') {
                 console.warn(`UI Notification (Info): ${message}`);
            } else {
                 console.log(`UI Notification (Success): ${message}`);
            }

            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.addEventListener('transitionend', () => notification.remove());
            }, 5000);
        }

        /**
         * Opens a generic modal by ID.
         * @param {string} modalId - The ID of the modal element.
         * @param {number|null} clusterId - The ID of the cluster to operate on (if needed).
         */
        function openModal(modalId, clusterId = null) {
            if (!userId) {
                redirectToLogin();
                return;
            }
            if (clusterId && document.getElementById('modalClusterId')) {
                document.getElementById('modalClusterId').value = clusterId;
            }
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }
        
        /**
         * Opens the VCF input modal.
         * @param {number} clusterId - The ID of the cluster the user is joining.
         */
        function showModal(clusterId) {
             openModal('inputModal', clusterId);
        }

        /**
         * Closes a generic modal by ID.
         * @param {string} modalId - The ID of the modal element.
         */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
                // Only reset the contactForm if it's the VCF modal
                if (modalId === 'inputModal') {
                    document.getElementById('contactForm').reset();
                }
            }
        }
        
        /**
         * Generates the unique share link for a cluster and copies it to the clipboard.
         * @param {number} clusterId - The ID of the cluster to share.
         */
        function generateShareLink(clusterId) {
            if (!userId) {
                redirectToLogin();
                return;
            }
            
            if (!userReferralCode) {
                 showNotification("Cannot share: Your referral code is not available yet.", 'error');
                 return;
            }

            // Construct the full referral URL
            const baseUrl = window.location.origin;
            // The URL path must be to this page, potentially clearing existing params
            const shareUrl = `${baseUrl}${window.location.pathname}?cluster_id=${clusterId}&ref_code=${userReferralCode}`;
            
            // Copy to clipboard
            try {
                // Use a temporary textarea element for clipboard copy robustness
                const tempInput = document.createElement('textarea');
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                showNotification('Share link copied to clipboard!', 'success');
                console.log(`Generated and copied link: ${shareUrl}`);

            } catch (err) {
                console.error('Failed to copy text: ', err);
                showNotification('Failed to copy link. Please manually copy this URL from the console.', 'error');
            }
        }

        /**
         * Fetches and displays statistics and member list for a specific cluster.
         * @param {number} clusterId - The ID of the cluster.
         * @param {string} clusterName - The name of the cluster.
         */
        async function viewClusterStats(clusterId, clusterName) {
            if (!userId) {
                redirectToLogin();
                return;
            }
            
            // Reset and show modal
            document.getElementById('statsModalTitle').textContent = `Cluster Statistics: ${clusterName}`;
            document.getElementById('statsPlaceholder').classList.remove('hidden');
            document.getElementById('statsList').classList.add('hidden');
            document.getElementById('memberTableBody').innerHTML = '';
            document.getElementById('memberLoading').textContent = 'Loading member list...';
            document.getElementById('memberLoading').classList.remove('hidden');
            document.getElementById('memberCount').textContent = '...';
            
            openModal('statsModal');
            
            // --- Fetch Data ---
            try {
                const response = await fetch(`/api/cluster-stats?cluster_id=${clusterId}&user_id=${userId}`);
                const result = await response.json();

                if (!response.ok || !result.success) {
                     const errorMsg = result.message || "Failed to fetch cluster statistics.";
                     document.getElementById('statsPlaceholder').textContent = `Error: ${errorMsg}`;
                     document.getElementById('memberLoading').textContent = 'Error loading members.';
                     throw new Error(errorMsg);
                }

                const { cohort_members, cluster_stats } = result;

                // 1. Update Stats Summary
                const statsList = document.getElementById('statsList');
                statsList.innerHTML = '';
                
                // MOCK STATS RENDERING: Replace with real data from cluster_stats when backend is ready
                const mockStats = [
                    `Average Age: ${cluster_stats.avg_age || 'N/A'}`,
                    `Median Age: ${cluster_stats.median_age || 'N/A'}`,
                    `Countries: ${Object.keys(cluster_stats.country_counts || {}).join(', ') || 'N/A'}`,
                    `Profession Mix: ${cluster_stats.profession_mix || 'N/A'}`
                ];

                document.getElementById('statsPlaceholder').classList.add('hidden');
                statsList.classList.remove('hidden');

                // For now, render the mock structure
                mockStats.forEach(stat => {
                    const li = document.createElement('li');
                    li.textContent = stat;
                    statsList.appendChild(li);
                });
                
                // 2. Update Member List
                const tableBody = document.getElementById('memberTableBody');
                tableBody.innerHTML = ''; // Clear loading content
                
                const currentMemberCount = cohort_members.length;
                document.getElementById('memberCount').textContent = currentMemberCount;
                document.getElementById('maxCount').textContent = MAX_COHORT_SIZE;

                if (currentMemberCount === 0) {
                     document.getElementById('memberLoading').textContent = 'No other members have joined yet.';
                     document.getElementById('memberLoading').classList.remove('hidden');
                } else {
                    cohort_members.forEach(member => {
                        const row = `
                            <tr class="hover:bg-gray-50">
                                <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${member.nickname}</td>
                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${member.age || 'N/A'}</td>
                                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${member.country || 'N/A'}</td>
                            </tr>
                        `;
                        tableBody.insertAdjacentHTML('beforeend', row);
                    });
                    document.getElementById('memberLoading').classList.add('hidden');
                }

            } catch (error) {
                console.error('Error fetching cluster stats:', error);
                showNotification(`Could not load statistics for ${clusterName}.`, 'error');
            }
        }


        /**
         * Renders the cluster cards based on the current state (from cache and membership).
         */
        function renderClusters() {
            try {
                console.log("Rendering cluster cards...");
                
                const grid = document.getElementById('clusterGrid');
                if (!grid) {
                     console.error("CRITICAL: 'clusterGrid' element not found!");
                     showNotification("Fatal Error: Cannot find the card display area.", 'error');
                     return; 
                }

                grid.innerHTML = ''; // Clear existing cards

                categories.forEach(category => {
                    const clusterId = category.id;
                    const clusterName = category.name; // Added for tooltips
                    const state = clusterStatusCache[clusterId] || { 
                        cohort_id: `Cluster_${clusterId}`, 
                        is_full: false, 
                        current_members: 0,
                        vcf_uploaded: false, 
                        vcf_file_name: null, 
                    };
                    
                    const userIsMember = userClusterMemberships[clusterId]?.user_is_member; 
                    const remaining = MAX_COHORT_SIZE - state.current_members;
                    const isDownloadReady = state.is_full && state.vcf_uploaded && state.vcf_file_name;

                    let primaryButtonHTML = '';
                    let actionButtonsHTML = '';
                    let cardClass = "card bg-white p-6 rounded-xl space-y-4";
                    
                    // Add highlighting for referral links
                    if (highlightedClusterId && category.id === highlightedClusterId) {
                        cardClass += " card-highlight";
                        if (!userIsMember && userId) {
                            showNotification(`You were invited to the '${category.name}' cluster!`, 'info');
                        }
                    }

                    if (!isAuthReady) {
                        primaryButtonHTML = `<button class="bg-gray-400 cursor-not-allowed w-full text-white font-semibold py-2 rounded-lg shadow-md" disabled>Loading...</button>`;
                    } else if (!userId) {
                        // Guest User
                        primaryButtonHTML = `<button class="login-prompt-btn w-full text-white font-semibold py-2 rounded-lg shadow-md" onclick="redirectToLogin()">Log in to Join</button>`;
                    } else if (userIsMember) {
                        // Authenticated Member (Show Action Buttons)
                        
                        // Action Buttons: Share & Stats
                        actionButtonsHTML = `
                            <div class="member-actions mt-3">
                                <button class="action-btn stats-btn" onclick="viewClusterStats(${clusterId}, '${clusterName}')">
                                    <i data-lucide="bar-chart-2" class="w-4 h-4 mr-1"></i> Stats
                                </button>
                                <button class="action-btn share-btn" onclick="generateShareLink(${clusterId})">
                                    <i data-lucide="share-2" class="w-4 h-4 mr-1"></i> Share
                                </button>
                                <!-- Placeholder for another action if needed, e.g., Leave Cohort -->
                                <div></div>
                            </div>
                        `;
                        
                        // Primary Button depends on cohort status
                        if (isDownloadReady) {
                            // Cohort is full and VCF is ready
                            const fileNameToUse = state.vcf_file_name || state.cohort_id; 
                            primaryButtonHTML = `<button class="download-btn hover:bg-green-700 w-full text-white font-semibold py-2 rounded-lg shadow-md" onclick="downloadContacts('${fileNameToUse}')">Download Contacts (VCF Ready)</button>`;
                        } else if (state.is_full && !isDownloadReady) {
                            // Cohort is full, but VCF is processing (Note: We agreed not to check vcf_uploaded, but keeping for user clarity)
                            primaryButtonHTML = `<button class="full-btn w-full text-white font-semibold py-2 rounded-lg shadow-md" disabled>Processing VCF... (Wait)</button>`;
                        } else {
                            // Cohort is still filling up
                            primaryButtonHTML = `<button class="full-btn w-full text-white font-semibold py-2 rounded-lg shadow-md" disabled>Joined! (${remaining} spots left)</button>`;
                        }

                    } else if (state.is_full && !userIsMember) {
                        // Authenticated Non-member: Cohort Full
                        primaryButtonHTML = `<button class="full-btn w-full text-white font-semibold py-2 rounded-lg shadow-md" disabled>Cluster Full (Wait for next)</button>`;
                    } else {
                        // Authenticated Non-member: Cohort Open
                        primaryButtonHTML = `<button class="join-btn w-full text-white font-semibold py-2 rounded-lg shadow-md" onclick="showModal(${clusterId})">Join Cluster (${remaining} spots open)</button>`;
                    }
                    
                    const cardHTML = `
                        <div class="${cardClass}" data-cluster-id="${clusterId}">
                            <h3 class="text-xl font-semibold text-blue-600">${category.name}</h3>
                            <p class="text-gray-500 text-sm h-16 line-clamp-3">
                                ${category.details}
                            </p>
                            ${primaryButtonHTML}
                            ${actionButtonsHTML}
                        </div>
                    `;
                    grid.insertAdjacentHTML('beforeend', cardHTML);
                });
                
                // Initialize Lucide icons after rendering cards
                lucide.createIcons();
                
                console.log("renderClusters finished.");

            } catch (error) {
                console.error("CRITICAL RENDER FAILURE:", error);
                showNotification(`Fatal rendering error: ${error.message}. Check console for details.`, 'error');
            }
        }
        
        // --- 3. CORE LOGIC (Node.js API Call Assumptions) ---

        /**
         * Checks the current status for all 10 categories on page load.
         */
        async function checkAllClusterStatuses() {
            if (!userId) {
                console.log("Skipping status check: User not logged in.");
                return;
            }
            
            showNotification('Checking cluster membership status...', 'info');

            const statusChecks = categories.map(async (category) => {
                const clusterId = category.id;
                
                // Use exponential backoff for robustness
                const MAX_RETRIES = 3;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        const response = await fetch(`/api/cohort-status?cluster_id=${clusterId}&user_id=${userId}`, {
                            method: 'GET',
                        });

                        const result = await response.json();

                        if (!response.ok || !result.success) {
                            throw new Error(result.message || 'Unknown status check error');
                        }
                        
                        // Update the global state caches to include vcf_file_name
                        clusterStatusCache[clusterId] = {
                            cohort_id: result.cohort_id,
                            is_full: result.is_full,
                            current_members: result.current_members,
                            vcf_uploaded: result.vcf_uploaded || false,
                            vcf_file_name: result.vcf_file_name || null, 
                        };

                        // Update membership cache based on server response
                        if (result.user_is_member) {
                            userClusterMemberships[clusterId] = { ...clusterStatusCache[clusterId], user_is_member: true };
                            // TODO: If the response included user profile data (e.g., ref_code), update userReferralCode here.
                        } else {
                             delete userClusterMemberships[clusterId];
                        }
                        return; // Success, exit retry loop

                    } catch (error) {
                        console.warn(`Status check failed for Cluster ${clusterId} (Attempt ${i + 1}/${MAX_RETRIES}):`, error.message);
                        if (i === MAX_RETRIES - 1) {
                            console.error(`Status check ultimately failed for Cluster ${clusterId}.`);
                            return;
                        }
                        // Exponential backoff wait
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }
            });

            await Promise.all(statusChecks);
            console.log("All cluster statuses checked. Rendering final state.");
            renderClusters(); // Render once all checks are complete
        }

        /**
         * Handles the form submission to join a cluster via the backend API.
         */
        async function handleFormSubmission(event) {
            event.preventDefault();

            if (!userId) {
                redirectToLogin();
                closeModal('inputModal');
                return;
            }

            const clusterId = document.getElementById('modalClusterId').value;
            const displayProfession = document.getElementById('displayProfession').checked; 
            
            // --- REFERRAL LOGIC INTEGRATION: Get p_ref_code from session ---
            const refCode = sessionStorage.getItem('referral_ref_code');
            
            const joinData = {
                p_cluster_id: parseInt(clusterId),
                p_display_profession: displayProfession,
                p_user_id: userId,
                p_ref_code: refCode, // Pass the referral code to the backend
            };
            
            closeModal('inputModal');
            showNotification(`Attempting to join cluster ${clusterId}...`, 'info');
            
            // Disable all buttons to prevent double-click while joining
            document.querySelectorAll('.card button').forEach(btn => btn.disabled = true);

            try {
                const response = await fetch('/api/join-cluster', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(joinData)
                });

                const result = await response.json(); 
                
                if (!response.ok || !result.success) {
                    const errorMessage = result.message || 'Server error during cluster join.';
                    console.error(`API Call Failed: ${errorMessage}`);
                    showNotification(errorMessage, 'error');
                    
                    await checkAllClusterStatuses(); 
                    return;
                }
                
                // --- SUCCESS: Clear Referral Session Data & Update Client State ---
                // We clear this only on successful join to prevent the new user from accidentally joining another cohort with the same ref_code
                sessionStorage.removeItem('referral_ref_code');
                sessionStorage.removeItem('referral_cluster_id');
                highlightedClusterId = null; 

                const { cohort_id, is_full, current_members } = result;
                
                clusterStatusCache[clusterId] = {
                    cohort_id: cohort_id,
                    is_full: is_full,
                    current_members: current_members,
                    vcf_uploaded: false, 
                    vcf_file_name: null,
                };
                
                userClusterMemberships[clusterId] = { ...clusterStatusCache[clusterId], user_is_member: true };
                
                renderClusters();
                
                if (is_full) {
                    showNotification(`Success! Cohort ${cohort_id} is now FULL. Checking VCF status...`, 'success');
                    await checkAllClusterStatuses(); 
                } else {
                    const remaining = MAX_COHORT_SIZE - current_members;
                    showNotification(`Successfully joined ${cohort_id}! Waiting for ${remaining.toLocaleString()} more members.`, 'success');
                }

            } catch (error) {
                console.error('Error joining cluster (Network/Parse error).', error);
                showNotification('An internal error occurred. Check console for details.', 'error');
            } finally {
                 if (!isAuthReady) {
                      document.querySelectorAll('.card button').forEach(btn => btn.disabled = false);
                 }
            }
        }

        /**
         * Initiates the download of the VCF file for a completed cohort.
         * @param {string} fileName - The full name of the VCF file in storage (e.g., 'Cluster_Contacts_C_1_1234.vcf').
         */
        async function downloadContacts(fileName) { 
            if (!userId) {
                redirectToLogin();
                return;
            }

            showNotification(`Requesting contact file: ${fileName}...`, 'info');

            try {
                const response = await fetch(`/api/download-contacts?file_name=${fileName}`, {
                    method: 'GET',
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(errorJson.message || 'Server error during contact file retrieval.');
                    } catch {
                         throw new Error(errorText || 'Failed to retrieve file. It may not be fully generated yet.');
                    }
                }

                const contentType = response.headers.get("Content-Type");

                if (contentType && contentType.includes('text/vcard')) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = fileName; 
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showNotification('Download started successfully!', 'success');
                } else {
                    throw new Error('The server did not return a valid VCF file format (expected text/vcard).');
                }

            } catch (error) {
                console.error('Download failed.', error);
                showNotification(error.message || 'Download failed. The file may not be fully generated yet.', 'error');
            }
        }
        
        /**
         * Handles referral parameters: reads from URL, persists to sessionStorage, and sets UI state.
         */
        function handleReferralParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const clusterIdFromUrl = urlParams.get('cluster_id');
            const refCodeFromUrl = urlParams.get('ref_code');

            // 1. If parameters exist in the URL, prioritize storing them for persistence through login/redirect
            if (clusterIdFromUrl && refCodeFromUrl) {
                sessionStorage.setItem('referral_cluster_id', clusterIdFromUrl);
                sessionStorage.setItem('referral_ref_code', refCodeFromUrl);
                console.log(`URL Referral Params captured and saved to session: Cluster ID ${clusterIdFromUrl}, Ref Code ${refCodeFromUrl.substring(0, 8)}...`);
            } else if (urlParams.get('cluster_id') || urlParams.get('ref_code')) {
                console.warn("Incomplete referral link detected in URL. Skipping session storage of incomplete link.");
            }
            
            // 2. Read the final state from sessionStorage (which persists across login redirect)
            const storedClusterId = sessionStorage.getItem('referral_cluster_id');
            
            if (storedClusterId) {
                highlightedClusterId = parseInt(storedClusterId);
                console.log(`Setting highlighted cluster ID from session storage: ${highlightedClusterId}`);
            }
        }

        // --- 4. SUPABASE INITIALIZATION (Client-side Silent Auth) ---
        async function initializeSupabase() {
            console.log("Supabase initialization sequence started.");
            
            if (!window.supabase || !window.supabase.createClient) {
                 console.error("FATAL: Supabase library not found on global window object.");
                 isAuthReady = true;
                 renderClusters();
                 return;
            }
            
            try {
                // Initialize the client
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

                // Attempt to retrieve the session token (silent authentication)
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    throw error;
                }

                if (session && session.user) {
                    userId = session.user.id;
                    console.log(`User Authenticated. ID: ${userId.substring(0, 8)}...`); 
                    
                    // --- MOCK: Fetch User's Referral Code Here ---
                    // TODO: Replace this MOCK fetch with a real Supabase/API call to get the user's current referral code.
                    userReferralCode = session.user.id.substring(0, 8).toUpperCase(); // Using truncated ID as MOCK code
                    console.log(`MOCK Referral Code set for user: ${userReferralCode}`);

                } else {
                    console.log("No active session found. Running as Guest.");
                }

            } catch (error) {
                console.error("Supabase Initialization Failed (Fatal).", error);
                showNotification("App failed to initialize. See console for details.", 'error');
                
            } finally {
                isAuthReady = true; 
                
                // CRITICAL: After auth check, load the state from the server for members/guests
                if (userId) {
                    await checkAllClusterStatuses(); 
                } else {
                    renderClusters(); // Render immediately if guest
                }
            }
        }

        // --- 5. INITIALIZATION ---

        // Stage 1: Handle referral parameters immediately
        handleReferralParams();

        // Expose required functions to the global scope for onclick handlers
        window.redirectToLogin = redirectToLogin; 
        window.downloadContacts = downloadContacts;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.generateShareLink = generateShareLink;
        window.viewClusterStats = viewClusterStats;
        
        // Add event listener for form submission
        document.getElementById('contactForm').addEventListener('submit', handleFormSubmission);
        
        // Start the application sequence
        initializeSupabase();

    </script>
</body>
</html>