<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEARR Leaderboard</title>
<script src="https://cdn.tailwindcss.com"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
    body {
        font-family: 'Inter', sans-serif;
    }
    /* Custom Blue Gradient Background matching the image style */
    .bg-leaderboard-gradient {
        background: linear-gradient(180deg, #1e40af 0%, #3b82f6 100%);
    }

    /* Profile image styles */
    .profile-img {
        width: 100%; 
        height: 100%;
        object-fit: contain;
    }

    .img-container {
        /* Size remains 32x32 for slimmer bars */
        width: 32px; 
        height: 32px;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        transform: rotate(-45deg); 
        border-radius: 0.5rem; 
        box-shadow: 0 0 0 2px white;
        flex-shrink: 0;
        background-color: #dbeafe; /* bg-blue-100 */
    }

    /* Custom style for the arrow/signboard shape on the list item */
    .leaderboard-item-pill {
        /* FIXED RIGHT POINT: Now uses calc(100% - 10px) on the top/bottom for a more pronounced arrow,
           but keeps the point tight on the right edge. */
        clip-path: polygon(0% 0%, 0% 100%, calc(100% - 10px) 100%, 100% 50%, calc(100% - 10px) 0%);
        border-radius: 0.5rem; 
        margin-right: -5px; 
    }

    /* Apply rounded corners only to the left side of the pill */
    .rounded-l-only {
        border-top-left-radius: 9999px; 
        border-bottom-left-radius: 9999px; 
    }
    
    body {
        background-color: white; 
    }

    /* Style for the icon text/emoji inside the rotated container */
    .icon-rotate-back {
        transform: rotate(45deg); /* Counter-rotate the icon */
        font-size: 18px; /* Icon size */
        line-height: 1;
    }
    
    /* CSS for collapsing the list */
    #leaderboardList {
        /* Set a more precise max-height for 20 items (20 * approx 40px height per item) */
        max-height: 800px; 
        overflow: hidden;
        /* Smoother transition */
        transition: max-height 0.7s ease-in-out; 
    }
    #leaderboardList.expanded {
        /* Set to a value greater than the max possible height (1000 items) for smooth fold-out */
        max-height: 50000px;
    }
    
    /* Hiding members via display:none is essential for the paged viewing logic */
    .hidden-member {
        display: none !important; 
    }
    .visible-member {
        /* Note: Keep this as flex to maintain layout when visible */
        display: flex !important;
    }


    /* Custom styles for SLEEK, MODERN BUTTONS with SMALLER FONTS */
    .btn-sleek {
        /* Reduced Padding */
        padding: 0.4rem 0.65rem; 
        /* Extra Bold */
        font-weight: 900; 
        /* Further Reduced Font Size for single line */
        font-size: 0.7rem; 
        /* Slightly deeper shadow for pop */
        box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.3);
        /* Ensure it's fully rounded */
        border-radius: 9999px; 
        display: flex;
        align-items: center;
        transition: all 0.2s ease-in-out;
        white-space: nowrap; /* Ensure it stays on one line */
    }

    /* Primary (Blue) Button Style */
    .btn-primary {
        color: white;
        background-color: #2563eb; /* Blue-600 */
        border: 2px solid #3b82f6; /* Blue-500 */
    }
    .btn-primary:hover {
        background-color: #1d4ed8; /* Blue-700 */
        border-color: #1e40af; /* Blue-800 */
    }

    /* Secondary (White/Collapse) Button Style */
    .btn-secondary {
        color: #1e40af; /* Blue-800 */
        background-color: white;
        border: 2px solid #dbeafe; /* Blue-100 */
    }
    .btn-secondary:hover {
        background-color: #eff6ff; /* Blue-50 */
        border-color: #93c5fd; /* Blue-300 */
    }


    /* Space reduction for the container when both buttons are visible */
    .dual-button-container {
        display: flex;
        justify-content: space-between;
        padding-top: 0.5rem; 
        padding-bottom: 0.75rem; 
        padding-left: 0.75rem; 
        padding-right: 0.75rem;
    }
    .single-button-container {
        display: flex;
        justify-content: center;
        padding-top: 0.5rem; 
        padding-bottom: 0.75rem; 
        padding-left: 0.75rem; 
        padding-right: 0.75rem;
    }
    
    /* Rank Movement Arrow Styles (Disabled/Removed for real data MVP) */
    .rank-arrow {
        display: none !important; /* Hide rank arrow when previous_rank data is unavailable */
    }

    /* Current User Highlight Style */
    .current-user-highlight .leaderboard-item-pill {
        /* Yellow border for visibility */
        border: 2px solid #fcd34d; /* yellow-300 */
        /* Slightly different background to stand out */
        background-color: #fffbeb; /* yellow-50 */
        /* Darker text/icons for contrast */
    }
    .current-user-highlight .leaderboard-item-pill .text-blue-600 {
        color: #b45309; /* amber-800 for points and rank number */
    }
    .current-user-highlight .leaderboard-item-pill .text-gray-800 {
        font-weight: 800; /* Extra bold name */
    }

    /* New: Referral Link Styling */
    .referral-input-container {
        display: flex;
        align-items: center;
        background-color: #ffffff;
        border-radius: 9999px; /* full-round */
        padding: 0.4rem 0.4rem 0.4rem 1.25rem; /* Padding left for text, small padding right */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        border: 2px solid #dbeafe;
        margin-top: 0.5rem;
    }
    .referral-input {
        flex-grow: 1;
        font-size: 0.8rem;
        font-weight: 600;
        color: #4b5563; /* gray-600 */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding-right: 0.5rem;
        user-select: none; /* Prevent easy selection of URL text */
    }
    .copy-btn {
        padding: 0.4rem 0.8rem;
        background-color: #1e40af; /* blue-800 */
        color: white;
        font-weight: 700;
        font-size: 0.7rem;
        border-radius: 9999px;
        transition: background-color 0.2s;
        flex-shrink: 0;
    }
    .copy-btn:hover {
        background-color: #102a7b; /* darker blue */
    }

    /* Card Styling */
    .sleek-card {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); /* bg-blue-50 to blue-100 */
        padding: 1rem;
        border-radius: 1rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        border: 1px solid #93c5fd; /* blue-300 */
    }
    
    /* Style for the Error Log Area */
    #collapsibleErrorLog {
        margin-top: 1rem;
        padding: 0; /* Padding is now inside the content area */
        background-color: #fee2e2; /* red-100 */
        border: 1px solid #f87171; /* red-400 */
        border-radius: 0.5rem;
        color: #b91c1c; /* red-700 */
        font-size: 0.875rem;
        font-weight: 600;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none; /* Hidden by default */
    }
    #collapsibleErrorLog.fatal {
        background-color: #fecaca; /* red-200 */
        border-color: #ef4444; /* red-500 */
    }
    #collapsibleErrorLog button {
        width: 100%;
        text-align: left;
        padding: 0.75rem;
        background-color: #fca5a5; /* red-300 */
        color: #991b1b; /* red-800 */
        border: none;
        font-weight: 700;
        border-radius: 0.5rem 0.5rem 0 0;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s;
    }
    #collapsibleErrorLog button:hover {
        background-color: #f87171; /* red-400 */
    }
    #errorLogContent {
        padding: 0.75rem;
        max-height: 200px;
        overflow-y: auto;
        font-family: monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        background-color: #fff;
        border-top: 1px solid #f87171;
        border-radius: 0 0 0.5rem 0.5rem;
        display: none; /* Hidden by default */
    }
    #errorLogContent.visible {
        display: block;
    }
</style>

<script>
    // --- Supabase Client Initialization ---
    // IMPORTANT: The Anon Key is safe to include here. Supabase will automatically
    // use the 'sb-access-token' cookie set by your server for authenticated requests.
    const SUPABASE_URL = 'https://jtnnyfxdjqhtqddisrvp.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0bm55ZnhkanFodHFkZGlzcnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDgyNDksImV4cCI6MjA4MDA4NDI0OX0.fFy_Z36VFHwOpZnSwR2WWlR_2b3hBrfEFXDp2EnAS9A';
    
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // ----------------------------------------
    

    // --- Global Configuration ---
    let CURRENT_USER_ID = null; 
    
    const BASE_REWARD = 100;
    const REFERRAL_REWARD = 20;
    const INITIAL_VISIBLE_COUNT = 20; // Ranks 4-23
    const EXPANSION_INCREMENT = 50; // New members to show or hide on each click
    
    // FIX 1: Updated the base URL to your render app index page
    const REFERRAL_BASE_URL = 'https://nearr.onrender.com/index.html?ref=';

    // --- State Variables ---
    let currentVisibleItems = INITIAL_VISIBLE_COUNT;
    let leaderboardData = []; // Stores the real data from the backend
    let currentUserData = null; // Will store the final sorted data for the current user.
    let CURRENT_USER_RANK = -1; 
    let totalListItems = 0; // Total users in the list (Ranks 4+)


    /**
     * Calculates the NRT score based on the referral count.
     * @param {number} referrals 
     * @returns {number} nrt_coins
     */
    function calculateNrtCoins(referrals) {
        return BASE_REWARD + (referrals * REFERRAL_REWARD);
    }
    
    // --- Error Logger Function (UPDATED) ---
    /**
     * Displays a message in the dedicated error log element.
     * @param {string} message The error or debug message to display.
     * @param {boolean} isFatal If true, uses a more prominent style.
     */
    function logErrorToDashboard(message, isFatal = false) {
        const errorLogContainer = document.getElementById('collapsibleErrorLog');
        const errorLogContent = document.getElementById('errorLogContent');
        const toggleButton = document.getElementById('errorLogToggle');
        
        if (errorLogContainer && errorLogContent) {
            // Prepend the new message to the content
            const timestamp = new Date().toLocaleTimeString();
            errorLogContent.innerHTML = `[${timestamp}] ${message}\n---\n` + errorLogContent.innerHTML;
            
            errorLogContainer.style.display = 'block'; // Ensure container is visible
            
            if (isFatal) {
                 errorLogContainer.classList.add('fatal');
            } else {
                 errorLogContainer.classList.remove('fatal');
            }
            
            // Update button text to show there are errors
            toggleButton.innerHTML = `‚ö†Ô∏è Error Log (${errorLogContent.children.length + 1} issues) <span id="logArrow">‚ñº</span>`;
        }
        console.error('LOGGED TO DASHBOARD:', message); // Keep console log for local debugging
    }
    
    /**
     * Toggles the visibility of the error log content.
     */
    function toggleErrorLog() {
        const content = document.getElementById('errorLogContent');
        const arrow = document.getElementById('logArrow');
        if (content.classList.contains('visible')) {
            content.classList.remove('visible');
            arrow.innerText = '‚ñº';
        } else {
            content.classList.add('visible');
            arrow.innerText = '‚ñ≤';
        }
    }
    
    // Global Error and Rejection Listeners
    window.addEventListener('error', function (e) {
        logErrorToDashboard(`Uncaught Error: ${e.message} (Line: ${e.lineno})`, true);
    });

    window.addEventListener('unhandledrejection', function (e) {
        logErrorToDashboard(`Unhandled Promise Rejection: ${e.reason}`, true);
    });
    
    // --------------------------------------------------------------------------
    // --- CORE FIX 1: Supabase Real-Time Session and Auth Check ---
    // --------------------------------------------------------------------------
    /**
     * Replaces the mock session check with the official Supabase session listener.
     */
    async function checkSessionAndLoad() {
        // 1. Listen for auth state changes (logs in, logs out, token refresh)
        supabaseClient.auth.onAuthStateChange((event, session) => {
            logErrorToDashboard(`Auth event: ${event}`, false); // Log auth events

            if (session) {
                // User is logged in (session is valid and fresh)
                CURRENT_USER_ID = session.user.id;
                console.log(`Session Active. User ID: ${CURRENT_USER_ID}`);
                
                // 2. Render the initial loading state and fetch data
                renderUserDashboard(true, { loading: true, nickname: session.user.user_metadata?.nickname });

                // 3. Proceed to fetch the actual leaderboard data
                fetchLeaderboardData();

            } else {
                // No session found (user logged out, token expired, or initial access failed)
                console.log('No active session. Redirecting to login.');
                
                // Token Expired / New Access / Logout
                // Redirect user to the login page
                window.location.href = '/login.html'; 
            }
        });

        // We don't need to do anything else here; onAuthStateChange handles the full lifecycle.
    }
    
    // --- Data Fetching ---
    
    /**
     * Fetches the REAL leaderboard data from the server's API endpoint.
     */
    async function fetchLeaderboardData() {
        // Show a loading message while waiting for the response
        document.getElementById('leaderboardList').innerHTML = `
            <p class="text-center text-white/70 p-8">
                Loading REAL data... (Current user: ${CURRENT_USER_ID})
            </p>
        `;

        let apiData = [];
        try {
            // --- REAL API CALL TO SERVER.JS ENDPOINT ---
            const response = await fetch('/api/secure-data');
            
            if (!response.ok) {
                // Log the full response status if it's not OK
                throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
            }
            apiData = await response.json();
            // --------------------------------------------
            
            // 1. Process Data: Calculate NRT coins for each member
            leaderboardData = apiData.map((member) => ({
                // Data structure expected from server.js: user_id, nickname, referrals, gender, referral_code
                id: member.user_id, 
                nickname: member.nickname,
                referrals: member.referrals,
                nrt_coins: calculateNrtCoins(member.referrals),
                gender: member.gender || 'male', 
                referral_code: member.referral_code, // ADDED: Ensure the code is mapped
            }));
            
            // 2. Identify Current User
            const CURRENT_USER_RANK_INDEX = leaderboardData.findIndex(member => member.id === CURRENT_USER_ID);
            CURRENT_USER_RANK = CURRENT_USER_RANK_INDEX !== -1 ? CURRENT_USER_RANK_INDEX + 1 : -1;
            currentUserData = leaderboardData.find(member => member.id === CURRENT_USER_ID);

            // 3. Render the full data set
            renderLeaderboard(leaderboardData);
            
        } catch (error) {
            logErrorToDashboard(`Data Fetch Error: ${error.message}`, true);
            document.getElementById('leaderboardList').innerHTML = `
                <p class="text-center text-red-300 p-8">Error loading leaderboard data.</p>`;
            renderUserDashboard(true, { error: true, message: 'Failed to fetch leaderboard data.' });
        }
    }


    // --- Core Logic (Unchanged) ---
    
    function copyToClipboard(elementId) {
        const copyText = document.getElementById(elementId).innerText;
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(copyText).then(() => {
                const button = document.getElementById('copyButton');
                const originalText = button.innerText;
                button.innerText = 'Copied!';
                button.classList.remove('bg-blue-800');
                button.classList.add('bg-green-600');
                
                setTimeout(() => {
                    button.innerText = originalText;
                    button.classList.add('bg-blue-800');
                    button.classList.remove('bg-green-600');
                }, 1500);
            }).catch(err => {
                logErrorToDashboard(`Copy failed: ${err.message}`);
            });
        } else {
            // Fallback for older browsers
            // document.execCommand('copy', false, copyText); // Use the direct text copy method
            const tempInput = document.createElement("input");
            tempInput.value = copyText;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
            
            const button = document.getElementById('copyButton');
            const originalText = button.innerText;
            button.innerText = 'Copied!';
            button.classList.remove('bg-blue-800');
            button.classList.add('bg-green-600');
            
            setTimeout(() => {
                button.innerText = originalText;
                button.classList.add('bg-blue-800');
                button.classList.remove('bg-green-600');
            }, 1500);
        }
    }


    function updateListVisibility() {
        const listContainer = document.getElementById('leaderboardList');
        const listItems = listContainer.querySelectorAll('.list-item-wrapper');
        
        // This count is for the list (Ranks 4+), which is total members - 3
        totalListItems = leaderboardData.length > 3 ? leaderboardData.length - 3 : 0; 
        
        let visibleCount = 0;

        listItems.forEach((item, index) => {
            if (index < currentVisibleItems) {
                item.classList.add('visible-member');
                item.classList.remove('hidden-member');
                visibleCount++;
            } else {
                item.classList.add('hidden-member');
                item.classList.remove('visible-member');
            }
        });

        // Update the button state
        updateToggleButton(totalListItems, visibleCount);
    }
    
    function updateToggleButton(totalListItems, visibleCount) {
        const buttonContainer = document.getElementById('toggleButtonContainer');
        const listContainer = document.getElementById('leaderboardList');
        
        if (!totalListItems) {
            buttonContainer.innerHTML = '';
            return;
        }

        // --- Manage Collapsing/Expanding Transition Class ---
        if (visibleCount > INITIAL_VISIBLE_COUNT) {
            listContainer.classList.add('expanded');
        } else {
            listContainer.classList.remove('expanded');
        }
        // ---------------------------------------------------

        if (visibleCount >= totalListItems) {
            // Case 1: Fully Expanded (Action: Reset to Top 23)
            buttonContainer.innerHTML = `
                <div class="single-button-container">
                    <button id="toggleButton" onclick="resetLeaderboardView()" class="btn-sleek bg-red-600 hover:bg-red-700 text-white">
                        Reset to Top ${INITIAL_VISIBLE_COUNT + 3} <span class="ml-2">‚ñ≤</span>
                    </button>
                </div>
            `;
        } else if (visibleCount > INITIAL_VISIBLE_COUNT) {
            // Case 2: Partially Expanded (Action: Show More or Show Less)
            
            const currentStepValue = currentVisibleItems - INITIAL_VISIBLE_COUNT;

            // --- Collapse logic: Calculate the exact number of items to hide (decrement) ---
            const collapseTargetVisibleItems = Math.max(INITIAL_VISIBLE_COUNT, currentVisibleItems - EXPANSION_INCREMENT);
            const collapseIncrement = currentVisibleItems - collapseTargetVisibleItems; 
            
            const nextCollapseStepValue = currentStepValue - collapseIncrement; 
            
            // --- Expansion logic: Calculate the exact number of items to show (nextExpansion) ---
            const remainingToExpand = totalListItems - visibleCount;
            const nextExpansion = Math.min(remainingToExpand, EXPANSION_INCREMENT); 
            
            const nextExpansionStepValue = currentStepValue + nextExpansion; 
            
            
            buttonContainer.innerHTML = `
                <div class="relative">
                    <div class="dual-button-container">
                        <button onclick="collapseLeaderboardView(${collapseIncrement})" class="btn-sleek btn-secondary">
                            <span class="mr-1">‚ñ≤</span> Show Less to ${nextCollapseStepValue + 23}
                        </button>
                        
                        <button onclick="expandLeaderboardView(${nextExpansion})" class="btn-sleek btn-primary">
                            Show up to ${nextExpansionStepValue + 23} <span class="ml-2">‚ñº</span>
                        </button>
                    </div>
                </div>
            `;

        } else {
            // Case 3: Initial View (Action: Show More + optional Go To My Rank button)
            const nextExpansion = EXPANSION_INCREMENT;
            const nextTotalRank = visibleCount + nextExpansion + 3; 
            
            if (CURRENT_USER_RANK > 23 && CURRENT_USER_RANK !== -1) {
                 // Current user is outside the initial view: offer Show More and Go To My Rank buttons
                 buttonContainer.innerHTML = `
                    <div class="relative">
                        <div class="dual-button-container">
                            <button onclick="goToMyRank()" class="btn-sleek btn-secondary">
                                <span class="mr-1">üè†</span> Go To My Rank (${CURRENT_USER_RANK})
                            </button>
                            
                            <button id="toggleButton" onclick="expandLeaderboardView(${nextExpansion})" class="btn-sleek btn-primary">
                                Show up to ${nextTotalRank} <span class="ml-2">‚ñº</span>
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Current user is already visible (or in top 3 or not found)
                buttonContainer.innerHTML = `
                    <div class="relative">
                        <div class="single-button-container">
                            <button id="toggleButton" onclick="expandLeaderboardView(${nextExpansion})" class="btn-sleek btn-primary">
                                Show up to ${nextTotalRank} <span class="ml-2">‚ñº</span>
                            </button>
                        </div>
                    </div>
                `;
            }
        }
    }
    
    function expandLeaderboardView(increment) {
        currentVisibleItems += increment;
        updateListVisibility();
    }
    
    function collapseLeaderboardView(decrement) {
        currentVisibleItems = Math.max(INITIAL_VISIBLE_COUNT, currentVisibleItems - decrement);
        updateListVisibility();
        
        if (currentVisibleItems === INITIAL_VISIBLE_COUNT) {
             const listContainer = document.getElementById('leaderboardList');
             listContainer.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
    
    function resetLeaderboardView() {
        currentVisibleItems = INITIAL_VISIBLE_COUNT;
        updateListVisibility(); 
        
        const listContainer = document.getElementById('leaderboardList');
        listContainer.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    /**
     * Finds the current user's rank (if > 3) and expands/scrolls to them.
     */
    function goToMyRank() {
        if (CURRENT_USER_RANK === -1 || CURRENT_USER_RANK <= 3) return;

        // The current user is at Rank N. The list items start at Rank 4.
        // List item index (0-based) = Rank - 4
        const targetIndex = CURRENT_USER_RANK - 4; 
        
        // 1. Set visibility to ensure the user's rank is shown
        currentVisibleItems = targetIndex + 1; 

        // 2. Update visibility and buttons
        updateListVisibility();
        
        // 3. Scroll to the element
        const listContainer = document.getElementById('leaderboardList');
        const targetElement = listContainer.children[targetIndex]; 

        if (targetElement) {
            // Wait slightly for the max-height transition to start before scrolling
            setTimeout(() => {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }
    }


    // --- Rendering ---
    // NOTE: Rank Movement is disabled as 'previous_rank' data is not available from the backend.
    function getRankMovementArrow(currentRank, previousRank) {
        return ''; // Return empty string to hide the element
    }

    /**
     * Renders the current user's personalized dashboard view.
     * @param {boolean} isLoggedIn True if session is active.
     * @param {object} status Optional status object {loading: true, error: true, message: '...'}
     */
    function renderUserDashboard(isLoggedIn, status = {}) {
        const dashboardElement = document.getElementById('userDashboardDetails');

        // Case 1: Not Logged In -> Show Login Prompt
        if (!isLoggedIn) {
            // This case should be handled by the redirect in onAuthStateChange, 
            // but is kept here as a fallback or if the page loads before redirect fires.
            dashboardElement.innerHTML = `
                <div class="sleek-card text-gray-800">
                    <p class="p-4 text-center text-red-500 font-semibold">
                        You must be logged in to view your profile dashboard. 
                        <a href="/login.html" class="text-blue-600 hover:text-blue-800 font-bold underline">Login here.</a>
                    </p>
                </div>
            `;
            return;
        }

        // Case 2: Logged In but still fetching data (Initial state after login/signup)
        if (status.loading) {
            dashboardElement.innerHTML = `
                <div class="sleek-card text-gray-800">
                    <p class="p-4 text-center text-gray-500 font-semibold">Loading your session and dashboard... üöÄ</p>
                    <div class="flex justify-end">
                        <button id="logoutButton" class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white font-bold text-xs rounded-full">Logout</button>
                    </div>
                </div>
            `;
            document.getElementById('logoutButton')?.addEventListener('click', handleLogout);
            return;
        }

        // Case 3: Logged In but Data Fetch Failed -> Show Error
        if (status.error) {
            dashboardElement.innerHTML = `
                <div class="sleek-card text-gray-800">
                    <p class="p-4 text-center text-red-500 font-semibold">
                        Error: ${status.message || 'Failed to load user data. Check error log for details.'}
                    </p>
                    <div class="flex justify-end">
                        <button id="logoutButton" class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white font-bold text-xs rounded-full">Logout</button>
                    </div>
                </div>
            `;
            document.getElementById('logoutButton')?.addEventListener('click', handleLogout);
            return;
        }
        
        // Case 4: Logged In but Data Loading Issue (e.g., missing referral code)
        if (!currentUserData || !currentUserData.referral_code) {
             dashboardElement.innerHTML = `
                <div class="sleek-card text-gray-800">
                    <p class="p-4 text-center text-orange-500 font-semibold">
                        Welcome back! Your dashboard data is loading, or referral code is missing.
                    </p>
                    <div class="flex justify-end">
                        <button id="logoutButton" class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white font-bold text-xs rounded-full">Logout</button>
                    </div>
                </div>
            `;
            document.getElementById('logoutButton')?.addEventListener('click', handleLogout);
            return;
        }

        // Case 5: Logged In and Data Loaded Successfully (The desired outcome)
        const referralCode = currentUserData.referral_code; 
        const referralLink = `${REFERRAL_BASE_URL}${referralCode}`;
        
        const rankMovementText = `<span class="text-gray-600 font-bold ml-1">Rank movement unavailable</span>`;

        dashboardElement.innerHTML = `
            <div class="sleek-card text-gray-800">
                <h3 class="text-xl font-extrabold text-blue-800 flex items-center mb-3">
                    <span class="mr-2 text-2xl">üë§</span> Your Profile
                </h3>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="p-3 bg-white rounded-lg shadow-inner">
                        <p class="text-sm font-semibold opacity-70">Current Rank</p>
                        <p class="text-2xl font-black text-blue-600">${CURRENT_USER_RANK !== -1 ? CURRENT_USER_RANK.toLocaleString() : 'N/A'}</p>
                        <p class="text-xs flex items-center">${rankMovementText}</p>
                    </div>
                    <div class="p-3 bg-white rounded-lg shadow-inner">
                        <p class="text-sm font-semibold opacity-70">NRT Balance</p>
                        <p class="text-2xl font-black text-amber-500">${currentUserData.nrt_coins.toLocaleString()}</p>
                        <p class="text-xs">(${currentUserData.referrals} Referrals)</p>
                    </div>
                </div>

                <div class="mb-4">
                    <h4 class="text-base font-bold text-blue-700 mb-2">Invite Friends & Earn NRT</h4>
                    <div class="referral-input-container">
                        <span id="referralLinkText" class="referral-input">${referralLink}</span>
                        <button id="copyButton" onclick="copyToClipboard('referralLinkText')" class="copy-btn">
                            COPY
                        </button>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">They join the waitlist at ${REFERRAL_BASE_URL.split('?')[0].replace('https://', '')}</p>
                    <p class="text-xs text-gray-600 mt-1">You both get ${REFERRAL_REWARD} NRT when they join!</p>
                </div>
                
                <div class="flex justify-end">
                    <button id="logoutButton" class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white font-bold text-xs rounded-full">Logout</button>
                </div>
            </div>
        `;
        
        // Add logout listener after the button is rendered
        document.getElementById('logoutButton')?.addEventListener('click', handleLogout);
    }
    
    async function handleLogout() {
        // CRITICAL FIX: Save the current page as the intended destination before logging out.
        // This ensures the user returns here after they log back in from the login page.
        sessionStorage.setItem('intended_destination', window.location.pathname + window.location.search);
        console.log(`Saved intended_destination: ${sessionStorage.getItem('intended_destination')}`);
        
        const { error } = await supabaseClient.auth.signOut();
        if (error) {
            logErrorToDashboard(`Logout failed: ${error.message}`);
        } else {
            // Redirect to login page after successful logout
            window.location.href = '/login.html'; 
        }
    }
    
    function renderLeaderboard(members) {
        // Render the user dashboard first, passing true since we have data
        renderUserDashboard(true);

        const top3Container = document.getElementById('top3Podium');
        const listContainer = document.getElementById('leaderboardList');
        
        top3Container.innerHTML = '';
        listContainer.innerHTML = '';

        if (members.length === 0) {
            listContainer.innerHTML = '<p class="text-center text-white/70 p-8">No members have joined yet!</p>';
            return;
        }

        // --- Render Top 3 Podium (Ranks 1, 2, 3) ---
        const top3Members = members.slice(0, 3);
        const placeholderCount = 3 - top3Members.length;
        
        // Add placeholders if less than 3 members
        for (let i = 0; i < placeholderCount; i++) {
            top3Members.push({ id: `placeholder-${i}`, nickname: 'TBD', referrals: 0, nrt_coins: BASE_REWARD, gender: 'male' });
        }


        const TrophyIcon = (size) => `<span class="${size} block">üèÜ</span>`;
        
        const getRankColorClasses = (rank) => {
             if (rank === 1) return 'text-yellow-300';
             if (rank === 2) return 'text-gray-300';
             if (rank === 3) return 'text-amber-500';
             return 'text-white/90';
        };

        const top3Ranks = [2, 1, 3]; // Order for rendering the visual pyramid (2, 1, 3)
        
        top3Ranks.forEach((rank, index) => {
            const memberIndex = rank - 1; // 0, 1, 2
            const member = top3Members[memberIndex];
            
            let orderClass, trophySize, heightClass; 

            if (rank === 1) {
                orderClass = 'order-2'; 
                trophySize = 'text-5xl';
                heightClass = 'pb-4 pt-1'; 
            } else if (rank === 2) {
                orderClass = 'order-1'; 
                trophySize = 'text-3xl';
                heightClass = 'pb-2';
            } else { 
                orderClass = 'order-3'; 
                trophySize = 'text-3xl';
                heightClass = 'pb-2';
            }
            
            const rankStyles = rank === 1 
                ? 'w-1/3 text-3xl font-extrabold' 
                : 'w-1/3 text-xl font-bold opacity-90'; 
            
            const colorClasses = getRankColorClasses(rank);
            
            // Highlight top 3 if current user is one of them
            const userHighlightClass = member.id === CURRENT_USER_ID ? 'ring-2 ring-yellow-300 rounded-lg' : '';
            const nickname = member.nickname.split(' ')[0] || 'TBD';

            const item = document.createElement('div');
            item.className = `flex flex-col items-center justify-end text-white/90 ${rankStyles} ${orderClass} ${heightClass} ${userHighlightClass}`;
            
            item.innerHTML = `
                <div class="text-lg font-black mb-1 opacity-70">${rank < 10 ? '0' : ''}${rank}</div>
                ${member.referrals > 0 ? TrophyIcon(trophySize) : `<span class="${trophySize} block">üë§</span>`}
                <div class="font-extrabold text-sm mt-1 text-center truncate w-full ${colorClasses}">${nickname}</div>
                <div class="text-xs font-medium text-center opacity-70">${member.nrt_coins.toLocaleString()}</div>
            `;
            top3Container.appendChild(item);
        });
        

        // --- Render Leaderboard List (Ranks 4+ / Remaining members) ---
        members.slice(3).forEach((member, index) => {
            const rank = index + 4; 
            
            // NOTE: Rank movement arrow is disabled using CSS and function override.
            const movementArrow = getRankMovementArrow(); 

            // Conditional Highlight Class
            const userHighlightClass = member.id === CURRENT_USER_ID ? 'current-user-highlight' : '';

            // Initial class setup: all members after the initial view count are hidden
            const visibilityClass = index < INITIAL_VISIBLE_COUNT ? 'visible-member' : 'hidden-member';
            
            const iconContent = member.gender === 'female' 
                ? '<span class="icon-rotate-back">üë©</span>' 
                : '<span class="icon-rotate-back">üë®</span>'; 
            
            const listItem = document.createElement('div');
            // Added both list-item-wrapper and the highlight class here
            listItem.className = `flex items-center list-item-wrapper ${visibilityClass} ${userHighlightClass}`; 
            
            listItem.innerHTML = `
                <div class="leaderboard-item-pill flex items-center justify-between bg-white shadow-md flex-grow min-w-0 transition duration-200 cursor-pointer overflow-hidden py-0.5 pl-4 pr-3 rounded-l-only">
                    
                    <div class="flex items-center space-x-3 flex-shrink-0"> 
                        <span class="text-sm font-semibold text-blue-600 w-6 text-center flex-shrink-0">${rank < 10 ? '0' : ''}${rank}</span>

                        <div class="img-container">
                            ${iconContent}
                        </div>
                        
                        ${movementArrow}

                        <span class="font-semibold text-gray-800 truncate text-sm">${member.nickname.split(' ')[0]}</span>
                    </div>

                    <div class="flex-grow text-center min-w-0 w-16 text-right">
                        <span class="text-sm font-semibold text-gray-700 whitespace-nowrap">
                            ${member.referrals}
                        </span>
                    </div>

                    <div class="flex items-center space-x-1 flex-shrink-0 pl-2">
                        <span class="text-sm font-semibold text-blue-600 whitespace-nowrap">
                            ${member.nrt_coins.toLocaleString()} NRT
                        </span>
                    </div>
                </div>
            `;
            listContainer.appendChild(listItem);
        });

        // Initial setup of the button
        updateListVisibility();
    }

    // --- Entry Point: Load data and render immediately ---
    window.onload = function() {
        // Reset state on load
        currentVisibleItems = INITIAL_VISIBLE_COUNT;
        
        // 1. Set the initial loading message immediately upon page load
        document.getElementById('userDashboardDetails').innerHTML = `
            <div class="sleek-card text-gray-800">
                <p class="p-4 text-center text-gray-500 font-semibold">Loading your session and dashboard... üöÄ</p>
            </div>
        `;
        
        // 2. Start the authentication check
        checkSessionAndLoad(); 
    };

</script>

</head>
<body class="bg-white min-h-screen">
    
    <div id="dashboardArea" class="bg-gray-100 p-4 sm:p-6 shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto space-y-4">
            
            <div id="collapsibleErrorLog" class="hidden">
                <button id="errorLogToggle" onclick="toggleErrorLog()">
                    ‚ö†Ô∏è Error Log (0 issues) <span id="logArrow">‚ñº</span>
                </button>
                <div id="errorLogContent">
                    </div>
            </div>
            <div id="userDashboardDetails" class="space-y-4">
                <p class="text-center text-gray-500">Loading User Dashboard...</p>
            </div>
            
            <div class="sleek-card text-gray-800">
                <h3 class="text-xl font-extrabold text-green-700 flex items-center mb-3">
                    <span class="mr-2 text-2xl">‚ö°Ô∏è</span> Boost Your NRT & Rank
                </h3>
                <p class="text-sm text-gray-700 mb-3">Complete these quick actions to earn bonus NRT and climb the leaderboard faster.</p>
                
                <div class="space-y-2">
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-green-200">
                        <span class="font-semibold text-sm">Follow @NEARR_Protocol on X</span>
                        <button class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white font-bold text-xs rounded-full">
                            +50 NRT
                        </button>
                    </div>
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-green-200">
                        <span class="font-semibold text-sm">Join the Telegram Group</span>
                        <button class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white font-bold text-xs rounded-full">
                            +50 NRT
                        </button>
                    </div>
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-green-200">
                        <span class="font-semibold text-sm">Set up NEAR Wallet</span>
                        <button class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white font-bold text-xs rounded-full">
                            +100 NRT
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <div class="flex justify-center p-4 sm:p-8">
        <div id="appContainer" class="leaderboard-container w-full max-w-xs sm:max-w-sm space-y-4 bg-leaderboard-gradient rounded-xl shadow-xl relative">
            <header class="text-center pt-6 pb-2 px-4 bg-white rounded-t-xl text-gray-900">
                <h1 class="text-3xl font-extrabold">
                    NEARR Leaderboard
                </h1>
                </header>

            <div id="top3Podium" class="flex justify-between items-end mb-4 py-4 px-2">
                </div>

            <div id="leaderboardList" class="space-y-2 px-6">
                <p class="text-center text-white/70">Loading Leaderboard...</p>
            </div>
            
            <div id="toggleButtonContainer" class="relative">
                </div>
            
        </div>
    </div>
</body>
</html>
