<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Cohorts Dashboard</title>
    <style>
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
        }

        .header-bar h1 {
            color: #007bff;
            font-size: 2.5em;
            font-weight: bold;
            margin: 0;
        }

        #createGroupBtn {
            background-color: #007bff;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .group-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .group-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }

        .slide-panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            visibility: hidden;
            opacity: 0;
            transition: .3s;
            z-index: 1000;
        }

        .slide-panel-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        .slide-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 400px;
            max-width: 90%;
            height: 100%;
            background: white;
            transform: translateX(100%);
            transition: .3s;
            padding: 20px;
        }

        .slide-panel-overlay.active .slide-panel {
            transform: translateX(0);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
        }

        .form-field {
            margin-bottom: 15px;
        }

        .form-field input,
        .form-field textarea,
        .form-field select {
            width: 100%;
            padding: 8px;
        }

        .submit-btn {
            width: 100%;
            padding: 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="header-bar">
    <h1>NEAR Network</h1>
    <button id="createGroupBtn">CREATE GROUP</button>
</div>

<div id="groupListContainer" class="group-list-container"></div>

<div id="createGroupPanelOverlay" class="slide-panel-overlay">
    <div class="slide-panel">
        <h2>
            Create New Group
            <button id="closePanelBtn" class="close-btn">&times;</button>
        </h2>

        <form id="createGroupForm">
            <div class="form-field">
                <input id="groupName" placeholder="Group Name" required>
            </div>

            <div class="form-field">
                <input id="maxMembers" type="number" min="2" max="50" value="10">
            </div>

            <div class="form-field">
                <textarea id="description" placeholder="Description"></textarea>
            </div>

            <div class="form-field">
                <select id="vcfType">
                    <option value="public">Public</option>
                    <option value="direct">Direct</option>
                </select>
            </div>

            <button class="submit-btn">Create Group</button>
            <p id="formStatus"></p>
        </form>
    </div>
</div>

<script>
    window.SUPABASE_URL = '__SUPABASE_URL_INJECTION__';
    window.SUPABASE_ANON_KEY = '__SUPABASE_ANON_KEY_INJECTION__';
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    let supabase = null;

    document.addEventListener('DOMContentLoaded', () => {

        // DOM refs (MOVED INSIDE DOM READY)
        const createGroupBtn = document.getElementById('createGroupBtn');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const overlay = document.getElementById('createGroupPanelOverlay');
        const form = document.getElementById('createGroupForm');
        const formStatus = document.getElementById('formStatus');

        // UI logic (cannot fail)
        const openPanel = () => overlay.classList.add('active');
        const closePanel = () => overlay.classList.remove('active');

        createGroupBtn.addEventListener('click', openPanel);
        closePanelBtn.addEventListener('click', closePanel);

        // Guarded Supabase init
        if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
            supabase = window.supabase.createClient(
                window.SUPABASE_URL,
                window.SUPABASE_ANON_KEY
            );
        } else {
            console.warn('Supabase not initialized');
        }

        // Form
        form.addEventListener('submit', e => {
            e.preventDefault();
            formStatus.textContent = 'Submitting...';

            fetch('/api/create-group', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: groupName.value,
                    max_members: +maxMembers.value,
                    description: description.value,
                    vcf_type: vcfType.value
                })
            })
            .then(r => r.json())
            .then(() => {
                formStatus.textContent = 'Group created';
                setTimeout(closePanel, 800);
                fetchGroups();
            })
            .catch(() => formStatus.textContent = 'Error');
        });

        async function fetchGroups() {
            const container = document.getElementById('groupListContainer');
            container.textContent = 'Loading...';

            try {
                const r = await fetch('/api/groups');
                const d = await r.json();
                container.innerHTML = d.groups?.map(g =>
                    `<div class="group-card"><h3>${g.name}</h3></div>`
                ).join('') || 'No groups';
            } catch {
                container.textContent = 'Failed to load';
            }
        }

        fetchGroups();
    });
</script>

</body>
</html>
