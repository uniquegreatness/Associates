<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NEARR Leaderboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  /* (kept your styles, truncated here for brevity) */
  body { font-family: Inter, sans-serif; background: white; }
  /* ... keep rest of your CSS unchanged ... */
  /* ensure #errorLog is visible when used */
  #errorLog { display:none; }
</style>
<script>
  // CONFIG
  const SUPABASE_URL = 'https://jtnnyfxdjqhtqddisrvp.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0bm55ZnhkanFodHFkZGlzcnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDgyNDksImV4cCI6MjA4MDA4NDI0OX0.fFy_Z36VFHwOpZnSwR2WWlR_2b3hBrfEFXDp2EnAS9A';

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let CURRENT_USER_ID = null;
  let leaderboardData = [];
  let currentUserData = null;
  let CURRENT_USER_RANK = -1;

  const BASE_REWARD = 100;
  const REFERRAL_REWARD = 20;
  const INITIAL_VISIBLE_COUNT = 20;
  const EXPANSION_INCREMENT = 50;
  let currentVisibleItems = INITIAL_VISIBLE_COUNT;

  function calculateNrtCoins(referrals){ return BASE_REWARD + (referrals * REFERRAL_REWARD); }

  function logErrorToDashboard(message, isFatal = false) {
    const errorLog = document.getElementById('errorLog');
    if (!errorLog) return;
    errorLog.innerText = `ERROR: ${message}`;
    errorLog.style.display = 'block';
    if (isFatal) errorLog.classList.add('fatal');
    console.error(message);
  }

  // --- Session + Auth handling ---
  async function checkSessionAndLoad() {
    // 1. Try immediate session fetch
    try {
      const { data: sessionData } = await supabaseClient.auth.getSession();
      const session = sessionData?.session || null;
      if (session) {
        CURRENT_USER_ID = session.user.id;
        renderUserDashboard(true, { loading: true, nickname: session.user.user_metadata?.nickname });
        // fetch leaderboard with token
        await fetchLeaderboardData(session.access_token);
      } else {
        // No session -> redirect to login page
        window.location.href = '/login.html';
      }
    } catch (e) {
      logErrorToDashboard('Failed to read session: ' + e.message, true);
      window.location.href = '/login.html';
    }

    // 2. Also listen for auth state changes
    supabaseClient.auth.onAuthStateChange(async (event, newSession) => {
      if (newSession && newSession.user) {
        CURRENT_USER_ID = newSession.user.id;
        renderUserDashboard(true, { loading: true, nickname: newSession.user.user_metadata?.nickname });
        await fetchLeaderboardData(newSession.access_token || newSession.session?.access_token);
      } else {
        // Logged out
        window.location.href = '/login.html';
      }
    });
  }

  // --- Fetch leaderboard from server with token ---
  async function fetchLeaderboardData(access_token) {
    const listEl = document.getElementById('leaderboardList');
    listEl.innerHTML = `<p class="text-center text-white/70 p-8">Loading REAL data... (Current user: ${CURRENT_USER_ID || 'unknown'})</p>`;

    try {
      let headers = { 'Content-Type': 'application/json' };
      if (access_token) headers['Authorization'] = `Bearer ${access_token}`;

      const resp = await fetch('/api/secure-data', { method: 'GET', headers, credentials: 'include' });
      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(`HTTP ${resp.status} ${text}`);
      }
      const apiData = await resp.json();

      leaderboardData = apiData.map(d => ({
        id: d.user_id,
        nickname: d.nickname,
        referrals: d.referrals,
        nrt_coins: calculateNrtCoins(d.referrals || 0),
        gender: d.gender || 'male',
      }));

      const idx = leaderboardData.findIndex(m => m.id === CURRENT_USER_ID);
      CURRENT_USER_RANK = idx !== -1 ? idx + 1 : -1;
      currentUserData = leaderboardData.find(m => m.id === CURRENT_USER_ID) || null;

      renderLeaderboard(leaderboardData);
    } catch (err) {
      logErrorToDashboard('Data Fetch Error: ' + err.message, true);
      // Fallback to an informative message but keep page alive
      document.getElementById('leaderboardList').innerHTML = `<p class="text-center text-red-300 p-8">Error loading leaderboard data.</p>`;
      renderUserDashboard(true, { error: true, message: 'Failed to fetch leaderboard data.' });
    }
  }

  // --- Copy to clipboard ---
  function copyToClipboard(elementId){
    const copyText = document.getElementById(elementId).innerText;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(copyText).then(()=> {
        const btn = document.getElementById('copyButton');
        if (!btn) return;
        const orig = btn.innerText;
        btn.innerText = 'Copied!';
        setTimeout(()=> btn.innerText = orig, 1500);
      }).catch(err => logErrorToDashboard('Copy failed: ' + err.message));
    }
  }

  // --- List visibility controls (kept your original logic but simplified for brevity) ---
  function updateListVisibility() {
    const listContainer = document.getElementById('leaderboardList');
    const listItems = listContainer.querySelectorAll('.list-item-wrapper');
    const totalListItems = leaderboardData.length > 3 ? leaderboardData.length - 3 : 0;
    let visibleCount = 0;
    listItems.forEach((item, index) => {
      if (index < currentVisibleItems) {
        item.classList.add('visible-member'); item.classList.remove('hidden-member'); visibleCount++;
      } else { item.classList.add('hidden-member'); item.classList.remove('visible-member'); }
    });
    updateToggleButton(totalListItems, visibleCount);
  }

  function updateToggleButton(totalListItems, visibleCount) {
    const buttonContainer = document.getElementById('toggleButtonContainer');
    const listContainer = document.getElementById('leaderboardList');
    if (!totalListItems) { buttonContainer.innerHTML = ''; return; }
    if (visibleCount > INITIAL_VISIBLE_COUNT) listContainer.classList.add('expanded'); else listContainer.classList.remove('expanded');
    if (visibleCount >= totalListItems) {
      buttonContainer.innerHTML = `<div class="single-button-container"><button id="toggleButton" onclick="resetLeaderboardView()" class="btn-sleek bg-red-600 text-white">Reset to Top ${INITIAL_VISIBLE_COUNT + 3} ‚ñ≤</button></div>`;
    } else if (visibleCount > INITIAL_VISIBLE_COUNT) {
      const currentStepValue = currentVisibleItems - INITIAL_VISIBLE_COUNT;
      const collapseTargetVisibleItems = Math.max(INITIAL_VISIBLE_COUNT, currentVisibleItems - EXPANSION_INCREMENT);
      const collapseIncrement = currentVisibleItems - collapseTargetVisibleItems;
      const nextCollapseStepValue = currentStepValue - collapseIncrement;
      const remainingToExpand = totalListItems - visibleCount;
      const nextExpansion = Math.min(remainingToExpand, EXPANSION_INCREMENT);
      const nextExpansionStepValue = currentStepValue + nextExpansion;
      buttonContainer.innerHTML = `
        <div class="relative">
          <div class="dual-button-container">
            <button onclick="collapseLeaderboardView(${collapseIncrement})" class="btn-sleek btn-secondary">‚ñ≤ Show Less to ${nextCollapseStepValue + 23}</button>
            <button onclick="expandLeaderboardView(${nextExpansion})" class="btn-sleek btn-primary">Show up to ${nextExpansionStepValue + 23} ‚ñº</button>
          </div>
        </div>`;
    } else {
      const nextExpansion = EXPANSION_INCREMENT;
      const nextTotalRank = visibleCount + nextExpansion + 3;
      if (CURRENT_USER_RANK > 23 && CURRENT_USER_RANK !== -1) {
        buttonContainer.innerHTML = `<div class="relative"><div class="dual-button-container"><button onclick="goToMyRank()" class="btn-sleek btn-secondary">üè† Go To My Rank (${CURRENT_USER_RANK})</button><button id="toggleButton" onclick="expandLeaderboardView(${nextExpansion})" class="btn-sleek btn-primary">Show up to ${nextTotalRank} ‚ñº</button></div></div>`;
      } else {
        buttonContainer.innerHTML = `<div class="relative"><div class="single-button-container"><button id="toggleButton" onclick="expandLeaderboardView(${nextExpansion})" class="btn-sleek btn-primary">Show up to ${nextTotalRank} ‚ñº</button></div></div>`;
      }
    }
  }

  function expandLeaderboardView(increment) { currentVisibleItems += increment; updateListVisibility(); }
  function collapseLeaderboardView(decrement) { currentVisibleItems = Math.max(INITIAL_VISIBLE_COUNT, currentVisibleItems - decrement); updateListVisibility(); if (currentVisibleItems === INITIAL_VISIBLE_COUNT) document.getElementById('leaderboardList').scrollTo({ top:0, behavior:'smooth' }); }
  function resetLeaderboardView(){ currentVisibleItems = INITIAL_VISIBLE_COUNT; updateListVisibility(); document.getElementById('leaderboardList').scrollTo({ top:0, behavior:'smooth' }); }
  function goToMyRank(){
    if (CURRENT_USER_RANK === -1 || CURRENT_USER_RANK <= 3) return;
    const targetIndex = CURRENT_USER_RANK - 4;
    currentVisibleItems = targetIndex + 1;
    updateListVisibility();
    const targetElement = document.getElementById('leaderboardList').children[targetIndex];
    if (targetElement) setTimeout(()=> targetElement.scrollIntoView({ behavior:'smooth', block:'center' }), 300);
  }

  // --- Rendering functions (kept your original content structure) ---
  function renderUserDashboard(isLoggedIn, status = {}) {
    const dashboardElement = document.getElementById('userDashboardDetails');
    if (!isLoggedIn) {
      dashboardElement.innerHTML = `<div class="sleek-card text-gray-800"><p class="p-4 text-center text-red-500 font-semibold">You must be logged in to view your profile dashboard. <a href="/login.html" class="text-blue-600 underline">Login here.</a></p></div>`; return;
    }
    if (status.loading) {
      dashboardElement.innerHTML = `<div class="sleek-card text-gray-800"><p class="p-4 text-center text-gray-500 font-semibold">Loading your session and dashboard... üöÄ</p><div class="flex justify-end"><button id="logoutButton" class="px-3 py-1 bg-gray-500 text-white text-xs rounded-full">Logout</button></div></div>`;
      document.getElementById('logoutButton')?.addEventListener('click', handleLogout);
      return;
    }
    if (status.error) {
      dashboardElement.innerHTML = `<div class="sleek-card text-gray-800"><p class="p-4 text-center text-red-500 font-semibold">Error: ${status.message || 'Failed to load user data.'}</p><div class="flex justify-end"><button id="logoutButton" class="px-3 py-1 bg-gray-500 text-white text-xs rounded-full">Logout</button></div></div>`;
      document.getElementById('logoutButton')?.addEventListener('click', handleLogout);
      return;
    }
    if (!currentUserData) {
      dashboardElement.innerHTML = `<div class="sleek-card text-gray-800"><p class="p-4 text-center text-orange-500 font-semibold">Welcome back! Your dashboard data is loading.</p><div class="flex justify-end"><button id="logoutButton" class="px-3 py-1 bg-gray-500 text-white text-xs rounded-full">Logout</button></div></div>`;
      document.getElementById('logoutButton')?.addEventListener('click', handleLogout);
      return;
    }

    const referralCode = (currentUserData.nickname || 'user').split(' ')[0].toLowerCase() + currentUserData.referrals;
    const referralLink = `https://nearr.xyz/join?ref=${referralCode}`;

    dashboardElement.innerHTML = `
      <div class="sleek-card text-gray-800">
        <h3 class="text-xl font-extrabold text-blue-800 flex items-center mb-3"><span class="mr-2 text-2xl">üë§</span> Your Profile</h3>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="p-3 bg-white rounded-lg shadow-inner">
            <p class="text-sm font-semibold opacity-70">Current Rank</p>
            <p class="text-2xl font-black text-blue-600">${CURRENT_USER_RANK !== -1 ? CURRENT_USER_RANK.toLocaleString() : 'N/A'}</p>
            <p class="text-xs flex items-center">Rank movement unavailable</p>
          </div>
          <div class="p-3 bg-white rounded-lg shadow-inner">
            <p class="text-sm font-semibold opacity-70">NRT Balance</p>
            <p class="text-2xl font-black text-amber-500">${currentUserData.nrt_coins.toLocaleString()}</p>
            <p class="text-xs">(${currentUserData.referrals} Referrals)</p>
          </div>
        </div>
        <div class="mb-4">
          <h4 class="text-base font-bold text-blue-700 mb-2">Invite Friends & Earn NRT</h4>
          <div class="referral-input-container">
            <span id="referralLinkText" class="referral-input">${referralLink}</span>
            <button id="copyButton" onclick="copyToClipboard('referralLinkText')" class="copy-btn">COPY</button>
          </div>
          <p class="text-xs text-gray-600 mt-1">You both get ${REFERRAL_REWARD} NRT when they join!</p>
        </div>
        <div class="flex justify-end">
          <button id="logoutButton" class="px-3 py-1 bg-gray-500 text-white text-xs rounded-full">Logout</button>
        </div>
      </div>`;
    document.getElementById('logoutButton')?.addEventListener('click', handleLogout);
  }

  async function handleLogout() {
    const { error } = await supabaseClient.auth.signOut();
    if (error) {
      logErrorToDashboard('Logout failed: ' + error.message);
    } else {
      window.location.href = '/login.html';
    }
  }

  function getRankMovementArrow(){ return ''; }

  function renderLeaderboard(members) {
    renderUserDashboard(true);
    const top3Container = document.getElementById('top3Podium');
    const listContainer = document.getElementById('leaderboardList');
    top3Container.innerHTML = '';
    listContainer.innerHTML = '';

    if (!members || members.length === 0) {
      listContainer.innerHTML = '<p class="text-center text-white/70 p-8">No members have joined yet!</p>';
      return;
    }

    // Top 3
    const top3Members = members.slice(0,3);
    while (top3Members.length < 3) top3Members.push({ id: 'placeholder', nickname: 'TBD', referrals:0, nrt_coins: BASE_REWARD, gender:'male' });
    const top3Ranks = [2,1,3];
    top3Ranks.forEach(rank => {
      const member = top3Members[rank-1];
      const nickname = (member.nickname || 'TBD').split(' ')[0];
      const item = document.createElement('div');
      item.className = 'flex flex-col items-center justify-end text-white/90 w-1/3';
      item.innerHTML = `<div class="text-lg font-black mb-1 opacity-70">${rank < 10 ? '0' : ''}${rank}</div><div class="text-5xl">${member.referrals>0 ? 'üèÜ' : 'üë§'}</div><div class="font-extrabold text-sm mt-1">${nickname}</div><div class="text-xs font-medium opacity-70">${member.nrt_coins.toLocaleString()}</div>`;
      top3Container.appendChild(item);
    });

    // Ranks 4+
    members.slice(3).forEach((member, index) => {
      const rank = index + 4;
      const userHighlightClass = member.id === CURRENT_USER_ID ? 'current-user-highlight' : '';
      const visibilityClass = index < INITIAL_VISIBLE_COUNT ? 'visible-member' : 'hidden-member';
      const iconContent = member.gender === 'female' ? '<span class="icon-rotate-back">üë©</span>' : '<span class="icon-rotate-back">üë®</span>';
      const listItem = document.createElement('div');
      listItem.className = `flex items-center list-item-wrapper ${visibilityClass} ${userHighlightClass}`;
      listItem.innerHTML = `
        <div class="leaderboard-item-pill flex items-center justify-between bg-white shadow-md flex-grow min-w-0 overflow-hidden py-0.5 pl-4 pr-3 rounded-l-only">
          <div class="flex items-center space-x-3 flex-shrink-0">
            <span class="text-sm font-semibold text-blue-600 w-6 text-center flex-shrink-0">${rank < 10 ? '0' : ''}${rank}</span>
            <div class="img-container">${iconContent}</div>
            <span class="font-semibold text-gray-800 truncate text-sm">${(member.nickname||'TBD').split(' ')[0]}</span>
          </div>
          <div class="flex-grow text-center min-w-0 w-16 text-right">
            <span class="text-sm font-semibold text-gray-700 whitespace-nowrap">${member.referrals}</span>
          </div>
          <div class="flex items-center space-x-1 flex-shrink-0 pl-2">
            <span class="text-sm font-semibold text-blue-600 whitespace-nowrap">${member.nrt_coins.toLocaleString()} NRT</span>
          </div>
        </div>`;
      listContainer.appendChild(listItem);
    });

    updateListVisibility();
  }

  // Entry point
  window.onload = function() {
    document.getElementById('userDashboardDetails').innerHTML = `<div class="sleek-card text-gray-800"><p class="p-4 text-center text-gray-500 font-semibold">Loading your session and dashboard... üöÄ</p></div>`;
    checkSessionAndLoad();
  };
</script>
</head>
<body class="bg-white min-h-screen">
  <div id="dashboardArea" class="bg-gray-100 p-4 sm:p-6 shadow-lg border-b border-gray-200">
    <div class="max-w-7xl mx-auto space-y-4">
      <div id="errorLog"></div>
      <div id="userDashboardDetails" class="space-y-4">
        <p class="text-center text-gray-500">Loading User Dashboard...</p>
      </div>

      <div class="sleek-card text-gray-800">
        <h3 class="text-xl font-extrabold text-green-700 flex items-center mb-3"><span class="mr-2 text-2xl">‚ö°Ô∏è</span> Boost Your NRT & Rank</h3>
        <p class="text-sm text-gray-700 mb-3">Complete these quick actions to earn bonus NRT and climb the leaderboard faster.</p>
        <div class="space-y-2">
          <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-green-200">
            <span class="font-semibold text-sm">Follow @NEARR_Protocol on X</span>
            <button class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded-full">+50 NRT</button>
          </div>
          <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-green-200">
            <span class="font-semibold text-sm">Join the Telegram Group</span>
            <button class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded-full">+50 NRT</button>
          </div>
          <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-green-200">
            <span class="font-semibold text-sm">Set up NEAR Wallet</span>
            <button class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded-full">+100 NRT</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="flex justify-center p-4 sm:p-8">
    <div id="appContainer" class="leaderboard-container w-full max-w-xs sm:max-w-sm space-y-4 bg-leaderboard-gradient rounded-xl shadow-xl relative">
      <header class="text-center pt-6 pb-2 px-4 bg-white rounded-t-xl text-gray-900">
        <h1 class="text-3xl font-extrabold">NEARR Leaderboard</h1>
      </header>

      <div id="top3Podium" class="flex justify-between items-end mb-4 py-4 px-2"></div>
      <div id="leaderboardList" class="space-y-2 px-6"><p class="text-center text-white/70">Loading Leaderboard...</p></div>
      <div id="toggleButtonContainer" class="relative"></div>
    </div>
  </div>
</body>
</html>