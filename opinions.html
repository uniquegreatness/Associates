<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Opinions (Supabase Ready)</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font --><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap">
    <style>
        /* Custom styling for a modern, mobile-friendly look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Light background */
        }
        .post-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 5px solid #e0e7ff; /* Light blue accent border */
        }
        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .poll-option:hover {
            background-color: #f0f9ff; /* Blue-50 hover */
        }

        /* Custom Toggle Switch for Anonymous Posting */
        .toggle-label {
            background-color: #d1d5db; /* gray-300 */
        }
        .toggle-label::before {
            content: '';
            position: absolute;
            width: 1.25rem; /* 5 */
            height: 1.25rem; /* 5 */
            border-radius: 9999px; /* full */
            background-color: #ffffff;
            top: 0.125rem; /* 0.5 */
            left: 0.125rem; /* 0.5 */
            transition: transform 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* State when checkbox is CHECKED (Anonymous is ACTIVE) */
        .anonymous-toggle:checked + .toggle-label {
            background-color: #3b82f6; /* blue-500 */
        }
        .anonymous-toggle:checked + .toggle-label::before {
            transform: translateX(1.5rem); /* Move to the right */
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Main Application Container --><div class="max-w-xl mx-auto p-4">

        <!-- Header --><header class="flex justify-between items-center py-4 border-b border-gray-200 sticky top-0 bg-white z-10">
            <h1 class="text-xl font-bold text-gray-800">Opinion Board</h1>
            <button id="openPostModalButton" class="p-2 bg-blue-500 text-white rounded-full shadow-lg hover:bg-blue-600 transition duration-150 active:scale-95 touch-manipulation">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                    <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                </svg>
            </button>
        </header>

        <!-- Status Message --><p id="statusMessage" class="text-center text-sm text-gray-500 mt-4">
            <span class="font-bold text-red-500">NOTE:</span> Showing mock data. Update SUPABASE_CONFIG variables to go live.
        </p>

        <!-- Feed Container --><div id="postsFeed" class="mt-6 space-y-4">
            <div class="text-center py-12 text-gray-500" id="initialLoadingMessage">Loading opinions...</div>
        </div>
    </div>

    <!-- Modals --><!-- 1. Post Creation Modal --><div id="postModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-white w-full max-w-lg mt-10 p-6 rounded-xl shadow-2xl transform scale-95 transition-transform duration-300 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Ask Anonymously</h2>
            
            <div class="relative mb-4">
                <textarea id="questionInput" rows="5" placeholder="Ask opinions anonymously, we listen we don't judge" 
                    class="w-full p-3 pb-12 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>

                <!-- ICON BUTTONS FOR RESPONSE TYPE --><div class="absolute bottom-1 right-1 flex space-x-2 p-2">
                    <button id="selectText" data-type="Text" title="Text Opinion" class="response-type-btn p-1 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 transition hover:border-blue-400 touch-manipulation">
                        <!-- Chat Bubble Icon --><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                    </button>
                    <button id="selectPoll" data-type="Poll" title="Poll Response" class="response-type-btn p-1 rounded-lg border-2 border-gray-300 text-gray-700 transition hover:border-blue-400 touch-manipulation">
                        <!-- Bar Chart Icon --><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                            <line x1="12" x2="12" y1="20" y2="10"/>
                            <line x1="18" x2="18" y1="20" y2="4"/>
                            <line x1="6" x2="6" y1="20" y2="16"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Poll Options Container --><div id="pollOptionsContainer" class="hidden mb-4 p-3 border border-dashed border-gray-300 rounded-lg space-y-2">
                <p class="text-sm font-medium text-gray-600">Enter up to 4 poll options:</p>
                <!-- All four options are visible in the modal --><input type="text" data-option-id="0" placeholder="Option 1" class="poll-option-input w-full py-1.5 px-3 border border-gray-300 rounded-md">
                <input type="text" data-option-id="1" placeholder="Option 2" class="poll-option-input w-full py-1.5 px-3 border border-gray-300 rounded-md">
                <input type="text" data-option-id="2" placeholder="Option 3 (Optional)" class="poll-option-input w-full py-1.5 px-3 border border-gray-300 rounded-md">
                <input type="text" data-option-id="3" placeholder="Option 4 (Optional)" class="poll-option-input w-full py-1.5 px-3 border border-gray-300 rounded-md">
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closePostModal()" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100 transition">Cancel</button>
                <button id="submitPostButton" class="p-3 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition active:scale-95 disabled:bg-blue-300 flex items-center justify-center" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send">
                        <path d="m22 2-7 20-4-9-9-4Z"/>
                        <path d="M22 2 11 13"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 2. Generic Message/Alert Modal --><div id="messageModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform scale-95 transition-transform duration-300">
            <h2 id="messageTitle" class="text-xl font-semibold mb-3 text-gray-800"></h2>
            <p id="messageContent" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end">
                <button onclick="closeMessageModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition active:scale-95">
                    Close
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- Supabase Configuration (UPDATE THESE) ---
        const SUPABASE_URL = 'YOUR_SUPABASE_PROJECT_URL'; 
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; 
        const POSTS_API_ENDPOINT = `${SUPABASE_URL}/rest/v1/posts`;

        // Dummy UUID for "anonymous" user tracking in the front-end
        const DUMMY_USER_ID = 'anon-' + Math.random().toString(36).substring(2, 8);
        window.userId = DUMMY_USER_ID; 
        
        let postsData = [];

        // --- Utility Functions ---

        /** Shows a custom modal message instead of using alert() */
        window.showMessageModal = (title, content) => {
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageContent').textContent = content;
            const modal = document.getElementById('messageModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.remove('scale-95');
        };

        window.closeMessageModal = () => {
            const modal = document.getElementById('messageModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.add('scale-95');
        };

        /** Formats a timestamp into a relative time string (e.g., '2 hours ago') */
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Just now';
            const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return "Just now";
        }
        
        /** Generates display information (name and avatar) for a response */
        function getUserDisplayInfo(userId, isAnonymous) {
            const getPseudoName = (id) => {
                // Generate a simple, deterministic name based on the last 5 chars of the ID
                const hash = id.slice(-5);
                // Simple mapping of hash to a color for the avatar background (for visual differentiation)
                const colors = ['bg-red-200', 'bg-blue-200', 'bg-green-200', 'bg-yellow-200', 'bg-purple-200'];
                const color = colors[parseInt(hash, 16) % colors.length];
                
                // Capitalize the first letter and return as a name
                const name = hash.charAt(0).toUpperCase() + hash.slice(1);
                
                return { name, color };
            };

            if (isAnonymous) {
                return {
                    name: 'Anon',
                    avatarHtml: `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M10 16s-2 1-6 1"/>
                            <path d="M12 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                        </svg>
                    `,
                    avatarClasses: 'w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 border border-gray-300'
                };
            } else {
                const { name, color } = getPseudoName(userId);
                return {
                    name: name,
                    avatarHtml: `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-700">
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    `,
                    avatarClasses: `w-8 h-8 flex items-center justify-center rounded-full ${color} border border-gray-300`
                };
            }
        }

        // --- Mock Data Generation ---

        function generateMockPosts(count = 30) {
            const mockPosts = [];
            const questionTemplates = [
                "What is your favorite productivity hack?", "Is remote work better than office work?",
                "Should AI art be regulated?", "What is the most underrated movie of the last decade?",
                "What programming language has the best community?", "Does pineapple belong on pizza?",
                "What is the hardest lesson you've learned in your career?", "If you could travel anywhere, where would it be?",
                "What is the future of mobile development?", "The best way to start the day is...",
            ];
            
            // Ensures some polls have 4 options
            const pollOptionsSets = [
                ["Yes", "No", "Maybe", "Unsure"],
                ["Generalist", "Specialist"],
                ["Coffee", "Tea", "Water"],
                ["Digital", "Physical", "Hybrid", "Doesn't Matter"],
                ["Option A", "Option B", "Option C", "Option D"],
            ];
            
            // An array of 10 mock user IDs to simulate diverse voters/responders
            const mockUserIds = Array.from({ length: 10 }, (_, i) => `mock_user_${i + 1}_${Math.random().toString(36).substring(7)}`);

            for (let i = 1; i <= count; i++) {
                const type = i % 3 === 0 || i % 7 === 0 ? 'Poll' : 'Text'; 
                const questionText = questionTemplates[i % questionTemplates.length];
                const postId = i;
                const created_at = new Date(Date.now() - (i * 3600000 * Math.random())).toISOString(); 
                
                let content;
                if (type === 'Poll') {
                    const optionTexts = pollOptionsSets[i % pollOptionsSets.length];
                    const options = optionTexts.map(text => ({ optionText: text, votes: [] }));
                    
                    // Add some random votes
                    const voters = mockUserIds.slice(0, Math.floor(Math.random() * 8) + 2);
                    voters.forEach(voter => {
                        const randomOptionIndex = Math.floor(Math.random() * options.length);
                        options[randomOptionIndex].votes.push(voter);
                    });

                    // Ensure our current user has voted on some polls for testing purposes
                    if (i % 5 === 0 && !options.some(o => o.votes.includes(window.userId))) {
                        options[0].votes.push(window.userId);
                    }

                    content = JSON.stringify({ pollOptions: options });
                } else {
                    const responses = Array.from({ length: Math.floor(Math.random() * 8) + 1 }, (_, j) => {
                        const responseUserId = mockUserIds[j % mockUserIds.length];
                        
                        return {
                            response: `This is a detailed opinion on: ${questionText.substring(0, 30)}.`,
                            userId: responseUserId,
                            isAnonymous: Math.random() > 0.6, // 40% chance of being anonymous
                            timestamp: new Date(Date.now() - (i * 100000 + j * 5000)).toISOString(),
                            // Upvotes/Downvotes removed
                        };
                    });
                    content = JSON.stringify({ textResponses: responses });
                }

                mockPosts.push({
                    id: postId,
                    created_at: created_at,
                    question_text: questionText,
                    response_type: type,
                    content: content
                });
            }
            return mockPosts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        }

        // --- Post Rendering Functions ---

        /** Creates the HTML for a single post card */
        function createPostCard(post) {
            const data = post; 
            const postId = data.id;
            const card = document.createElement('div');
            card.className = 'post-card bg-white p-5 rounded-xl border border-gray-200';
            
            const content = data.content ? JSON.parse(data.content) : {}; 

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-1">
                            Asked Anonymously
                            <span class="text-xs text-gray-400 ml-2">${formatTimestamp(data.created_at)}</span>
                        </p>
                        <h3 class="text-lg font-bold text-gray-900 mb-3">${data.question_text}</h3>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${data.response_type === 'Poll' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">
                        ${data.response_type}
                    </span>
                </div>
                <div id="responseArea-${postId}" class="mt-4 border-t border-gray-100 pt-4">
                </div>
            `;

            const responseArea = card.querySelector(`#responseArea-${postId}`);
            if (data.response_type === 'Text') {
                renderTextResponseArea(responseArea, content, postId);
            } else if (data.response_type === 'Poll') {
                renderPollResponseArea(responseArea, content, postId);
            }

            return card;
        }

        /** Renders the text response area (input box and previous comments) */
        function renderTextResponseArea(container, content, postId) {
            let responses = content.textResponses || [];
            
            // Responses are now sorted by timestamp (newest first)
            responses.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const shortUserId = window.userId.substring(0, 8);

            container.innerHTML = `
                <!-- Cleaned up response list --><div class="space-y-3 mb-4 max-h-40 overflow-y-auto pr-2">
                    ${responses.slice(0, 5).map((res, index) => {
                        const displayInfo = getUserDisplayInfo(res.userId, res.isAnonymous);
                        
                        return `
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 shadow-sm flex flex-col space-y-2">
                                <!-- Avatar and Name Header --><div class="flex items-center space-x-2 text-xs font-medium">
                                    <div class="${displayInfo.avatarClasses}">${displayInfo.avatarHtml}</div>
                                    <span class="text-gray-700">${displayInfo.name}</span>
                                    <span class="text-gray-400 ml-2">${formatTimestamp(res.timestamp)}</span>
                                </div>
                                
                                <!-- Response Content --><p class="text-sm text-gray-700">${res.response}</p>
                            </div>
                        `;
                    }).join('')}
                    ${responses.length > 5 ? `<p class="text-sm text-gray-500 pt-1">...and ${responses.length - 5} more opinions (sorted by recent)</p>` : ''}
                    ${responses.length === 0 ? `<p class="text-sm text-gray-500">Be the first to share your opinion!</p>` : ''}
                </div>
                
                <div class="flex flex-col space-y-2">
                    <!-- Toggle for identity --><div class="flex items-center justify-end">
                        <span class="text-xs font-medium text-gray-500 mr-2">Post as ${shortUserId}...</span>
                        
                        <!-- Checkbox is UNCHECKED by default, meaning POSTING as ID. CHECKED means ANONYMOUS. --><div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="anonymousToggle-${postId}" class="anonymous-toggle sr-only">
                            <label for="anonymousToggle-${postId}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                        <span class="text-xs font-medium text-gray-500">Anonymous</span>
                    </div>

                    <!-- Input and Button --><div class="flex space-x-2">
                        <input type="text" id="textResponseInput-${postId}" placeholder="Share your opinion..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <button id="submitTextResponse-${postId}" class="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition active:scale-95 touch-manipulation">
                            Send
                        </button>
                    </div>
                </div>
            `;

            const input = container.querySelector(`#textResponseInput-${postId}`);
            const button = container.querySelector(`#submitTextResponse-${postId}`);
            button.onclick = () => submitTextResponse(postId, input.value, responses);
        }

        /** Renders the poll response area (options, counts, and voting logic) */
        function renderPollResponseArea(container, content, postId) {
            const options = content.pollOptions || [];
            // Check if DUMMY_USER_ID is in any of the votes arrays
            const hasVoted = options.some(opt => (opt.votes || []).includes(window.userId)); 
            const totalVotes = options.reduce((sum, opt) => sum + (opt.votes || []).length, 0);

            container.innerHTML = `
                <p class="text-xs font-medium text-gray-600 mb-2">
                    ${hasVoted ? 'Results Breakdown (Tap to change vote):' : 'Select your choice:'}
                </p>
                <div class="space-y-1">
                    ${options.map((opt, index) => {
                        const votes = opt.votes ? opt.votes.length : 0;
                        const percentage = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
                        const isUserVote = (opt.votes || []).includes(window.userId);

                        // Use JSON.stringify and replace to safely pass the whole content object for local updates
                        const contentToPass = JSON.stringify(content).replace(/"/g, '&quot;');

                        return `
                            <button data-option-index="${index}" 
                                class="poll-option w-full py-2 px-3 rounded-lg text-left transition relative overflow-hidden text-sm 
                                border border-gray-300 hover:bg-blue-50 hover:border-blue-400 active:scale-[0.99] touch-manipulation"
                                onclick="submitPollVote('${postId}', ${index}, '${contentToPass}')">
                                
                                <!-- Poll Bar Background - Reduced size and opacity for subtle look --><div class="absolute inset-y-0 left-0 bg-blue-200/70" style="width: ${percentage}%;"></div>

                                <div class="flex justify-between items-center relative z-10">
                                    <span class="text-sm font-medium ${isUserVote ? 'text-blue-800 font-bold' : 'text-gray-800'}">
                                        ${opt.optionText}
                                        ${isUserVote ? ' <span class="text-xs text-blue-600">(Your Vote)</span>' : ''}
                                    </span>
                                    
                                    <!-- Display results on the right, always show percentage if there is a vote -->${totalVotes > 0 ? `
                                        <div class="flex items-center text-xs font-semibold text-gray-700 ml-4 space-x-1">
                                            <span class="text-gray-500">${votes} Votes</span>
                                            <span class="text-blue-700 font-bold">(${percentage}%)</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </button>
                        `;
                    }).join('')}
                </div>
                <p class="text-xs text-gray-400 mt-2 text-right">Total Participants: ${totalVotes}</p>
            `;
        }

        // --- Supabase Interaction Simulation (using fetch) ---
        
        const useMockData = () => SUPABASE_URL === 'YOUR_SUPABASE_PROJECT_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY';


        /** Fetches posts from the Supabase 'posts' table (or mock data) */
        async function loadPosts() {
            // The message is visible by default, so we only remove the hidden class if it were added elsewhere, 
            // but we ensure it is hidden in the 'finally' block once we attempt to render data.
            document.getElementById('initialLoadingMessage').classList.remove('hidden');

            try {
                if (useMockData()) {
                    if (postsData.length === 0) {
                        postsData = generateMockPosts(30);
                    }
                    renderFeed();
                    return; 
                }

                // --- Live Supabase Fetch (only runs if keys are set) ---
                // ... (API fetch logic)

            } catch (error) {
                console.error("Error loading posts from Supabase:", error);
                window.showMessageModal('Connection Error', `Could not fetch posts. Error: ${error.message}`);
            } finally {
                 document.getElementById('initialLoadingMessage').classList.add('hidden');
            }
        }
        
        /** Renders the current postsData array to the UI */
        function renderFeed() {
            const feedContainer = document.getElementById('postsFeed');
            feedContainer.innerHTML = '';
            
            if (postsData.length === 0) {
                feedContainer.innerHTML = '<p class="text-center text-gray-500 py-12">No opinions asked yet! Be the first to post.</p>';
                return;
            }

            postsData.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            postsData.forEach(post => {
                feedContainer.appendChild(createPostCard(post));
            });
        }

        /** Submits a text response to a post by updating the 'content' field */
        window.submitTextResponse = async (postId, responseText, currentResponses) => {
            if (responseText.length < 1) return;
            
            // Checkbox state: true means ANONYMOUS
            const isAnonymous = document.getElementById(`anonymousToggle-${postId}`)?.checked === true;
            
            const newResponses = [...currentResponses, {
                userId: window.userId,
                response: responseText.trim(),
                isAnonymous: isAnonymous,
                timestamp: new Date().toISOString(),
                // Upvotes/Downvotes removed
            }];
            
            const newContent = { textResponses: newResponses };

            if (useMockData()) {
                const postIndex = postsData.findIndex(p => p.id == postId);
                if (postIndex !== -1) {
                    postsData[postIndex].content = JSON.stringify(newContent);
                }
                renderFeed();
                document.getElementById(`textResponseInput-${postId}`).value = '';
                return;
            }

            // --- Live Supabase Patch ---
            window.showMessageModal('Response Failed', 'Please set the Supabase URL and Key to submit responses.');
        };

        /** Submits a poll vote for a post by updating the 'content' field, now allowing vote change */
        window.submitPollVote = async (postId, optionIndex, currentContentStr) => {
            // Un-escape quotes from HTML attribute
            const currentContent = JSON.parse(currentContentStr.replace(/&quot;/g, '"'));
            let options = currentContent.pollOptions || [];

            // 1. Remove user's vote from ALL options (to allow changing the vote)
            options.forEach(opt => {
                opt.votes = (opt.votes || []).filter(voterId => voterId !== window.userId);
            });

            // 2. Add user's vote to the selected option
            options[optionIndex].votes.push(window.userId);

            const newContent = { pollOptions: options };

            if (useMockData()) {
                const postIndex = postsData.findIndex(p => p.id == postId);
                if (postIndex !== -1) {
                    postsData[postIndex].content = JSON.stringify(newContent);
                }
                renderFeed();
                return;
            }

            // --- Live Supabase Patch ---
            window.showMessageModal('Vote Failed', 'Please set the Supabase URL and Key to submit votes.');
        };

        // --- Post Creation Handlers ---

        function openPostModal() {
            // Reset modal state
            document.getElementById('questionInput').value = '';
            document.getElementById('pollOptionsContainer').classList.add('hidden');
            document.querySelectorAll('.poll-option-input').forEach(input => input.value = '');
            document.getElementById('submitPostButton').disabled = true;
            
            // Default to text (visually select the text button)
            document.getElementById('selectText').click(); 
            
            const modal = document.getElementById('postModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.remove('scale-95');
        }

        function closePostModal() {
            const modal = document.getElementById('postModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.add('scale-95');
        }

        /** Handles Post Type Selection (Text/Poll) */
        function handleResponseTypeSelection(type) {
            document.getElementById('pollOptionsContainer').classList.toggle('hidden', type !== 'Poll');
            
            // Update button styles
            document.querySelectorAll('.response-type-btn').forEach(btn => {
                const isSelected = btn.getAttribute('data-type') === type;
                if (isSelected) {
                    btn.classList.replace('border-gray-300', 'border-blue-500');
                    btn.classList.replace('text-gray-700', 'text-blue-700');
                    btn.classList.add('bg-blue-50');
                } else {
                    btn.classList.replace('border-blue-500', 'border-gray-300');
                    btn.classList.replace('text-blue-700', 'text-gray-700');
                    btn.classList.remove('bg-blue-50');
                }
            });
            checkPostFormValidity();
        }

        /** Validates the post form based on type and input */
        function checkPostFormValidity() {
            const question = document.getElementById('questionInput').value.trim();
            let isValid = question.length > 5;
            
            const isPoll = !document.getElementById('pollOptionsContainer').classList.contains('hidden');
            
            if (isPoll) {
                // For a poll, need at least 2 non-empty options
                const optionInputs = Array.from(document.querySelectorAll('.poll-option-input'));
                const filledOptions = optionInputs.filter(input => input.value.trim().length > 0);
                if (filledOptions.length < 2) {
                    isValid = false;
                }
            }
            
            document.getElementById('submitPostButton').disabled = !isValid;
        }

        /** Submits the new post (mock or live) */
        async function submitPost() {
            const question = document.getElementById('questionInput').value.trim();
            if (!question) return;

            const isPoll = !document.getElementById('pollOptionsContainer').classList.contains('hidden');
            const responseType = isPoll ? 'Poll' : 'Text';
            let content = {};
            
            if (isPoll) {
                const options = Array.from(document.querySelectorAll('.poll-option-input'))
                    .map(input => input.value.trim())
                    .filter(text => text.length > 0)
                    .map(text => ({ optionText: text, votes: [] }));
                content = { pollOptions: options };
            } else {
                content = { textResponses: [] };
            }
            
            const newPost = {
                id: Date.now(), // Mock ID
                created_at: new Date().toISOString(),
                question_text: question,
                response_type: responseType,
                content: JSON.stringify(content)
            };

            if (useMockData()) {
                postsData.unshift(newPost); // Add to the start
                renderFeed();
                closePostModal();
                return;
            }

            // --- Live Supabase Submission ---
             window.showMessageModal('Submission Failed', 'Please set the Supabase URL and Key to submit a new post.');
        }

        // --- Event Listeners and Initialization ---

        function initListeners() {
            // Modal Open/Close
            document.getElementById('openPostModalButton').addEventListener('click', openPostModal);
            
            // Post Type Selection
            document.getElementById('selectText').addEventListener('click', () => handleResponseTypeSelection('Text'));
            document.getElementById('selectPoll').addEventListener('click', () => handleResponseTypeSelection('Poll'));

            // Form Validation
            document.getElementById('questionInput').addEventListener('input', checkPostFormValidity);
            document.querySelectorAll('.poll-option-input').forEach(input => {
                input.addEventListener('input', checkPostFormValidity);
            });
            
            // Submit Button
            document.getElementById('submitPostButton').addEventListener('click', submitPost);
            
            // Initial call to load data
            loadPosts(); 
        }

        // Execute initialization when the DOM is ready
        document.addEventListener('DOMContentLoaded', initListeners);
    </script>
</body>
</html>

