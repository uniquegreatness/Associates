<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Signup Process</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* Configure Tailwind to use the Inter font */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f7f9fc;
    }
    
    /* Standard Input and Select styling consistency */
    input[type="text"], input[type="email"], input[type="password"], select, input[type="tel"] {
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        width: 100%;
        box-sizing: border-box;
        transition: border-color 0.2s;
    }
    input:focus, select:focus {
        border-color: #3b82f6;
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }

    /* Tag Styling */
    .tag {
        display: inline-block;
        background-color: #e5e7eb;
        color: #4b5563;
        padding: 0.5rem 1rem;
        margin: 0.35rem;
        border-radius: 9999px;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s, transform 0.1s;
        font-size: 0.875rem;
        user-select: none;
        border: 1px solid #d1d5db;
    }
    .tag:hover {
        background-color: #d1d5db;
    }
    .tag.selected {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
        transform: scale(1.03);
    }

    /* Modal Styling */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.75);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 100;
    }
    .modal-overlay.open {
        display: flex;
    }
    .modal-content {
        max-height: 80vh;
        overflow-y: auto;
    }
    
    /* Custom Styling for the Continue Button positioning */
    #profileView {
        position: relative; 
        padding-bottom: 5rem; 
    }
    
    .continue-button-container {
        position: absolute;
        bottom: 0;
        right: 0;
        transform: translateY(-50%); 
        z-index: 20;
    }

    /* Card Styling for Tag Sections */
    .tag-card {
        background-color: #f9f9f9;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1rem; 
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
        margin-top: 0.5rem;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.85);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 50;
        border-radius: 0.75rem;
    }
    /* Simple spinner animation */
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

</head>
<body class="p-4 sm:p-6 md:p-8">

<div class="max-w-xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl space-y-6">

    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p class="text-gray-700 font-medium">Loading application data...</p>
    </div>

    <div id="profileView" class="relative">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Tell us about yourself so we can properly match you with people of like minds</h2>

        <form id="signupForm" class="space-y-6">

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">WhatsApp Number:</label>
                <div class="flex space-x-2">
                    <select id="countryCode" name="countryCode" class="w-1/3" required>
                        <option value="">Loading Codes...</option>
                    </select>
                    <input type="tel" id="whatsappNumber" name="whatsappNumber" placeholder="Enter local number" class="w-2/3" required>
                </div>
                <small id="whatsapp-error" class="text-xs text-red-500 mt-1 block hidden">
                    The phone number format does not match the selected country code.
                </small>
            </div>

            <div>
                <label for="fullname" class="block text-sm font-medium text-gray-700 mb-1">Full Name:</label>
                <input type="text" id="fullname" name="fullname" placeholder="Enter your full name" required>
            </div>
            
            <div>
                <label for="nickname" class="block text-sm font-medium text-gray-700 mb-1">Nickname:</label>
                <input type="text" id="nickname" name="nickname" placeholder="Your WhatsApp Name" required>
                <small class="text-xs text-gray-500 mt-1 block">
                    <strong class="font-bold">This is the name your new status viewers will see you as on Whatsapp</strong>
                </small>
            </div>

            <div>
                <label for="profession" class="block text-sm font-medium text-gray-700 mb-1">Profession (Optional):</label>
                <input type="text" id="profession" name="profession" placeholder="e.g., Software Engineer, Marketer, Student">
                <small class="text-xs text-gray-500 mt-1 block">
                    <strong class="font-bold">This will be added to your nickname on Whatsapp to signify what you do to your new viewers so that potential customers can easily identify you (e.g., Moses (Doctor)). You should be able to turn this off later in settings.</strong>
                </small>
            </div>

            <h2 class="text-xl font-semibold text-gray-800 pt-4 border-t border-gray-200">Tell Us About Yourself</h2>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="age" class="block text-sm font-medium text-gray-700 mb-1">Age:</label>
                    <select id="age" name="age" required>
                        <option value="">Select Age</option>
                    </select>
                </div>

                <div>
                    <label for="gender" class="block text-sm font-medium text-gray-700 mb-1">Gender:</label>
                    <select id="gender" name="gender" required>
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
            </div>

            <div>
                <label for="country" class="block text-sm font-medium text-gray-700 mb-1">Country:</label>
                <select id="country" name="country" required>
                    <option value="">Loading Countries...</option>
                </select>
            </div>

            <div>
                <label for="state" class="block text-sm font-medium text-gray-700 mb-1">State/Region:</label>
                 <select id="state" name="state" required disabled>
                    <option value="">Select a Country first</option>
                </select>
            </div>

            <div>
                <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City/Town:</label>
                 <select id="city" name="city" required disabled>
                    <option value="">Select a State/Region first</option>
                </select>
            </div>

            <div class="tag-card">
                <h3 class="text-lg font-semibold text-gray-800">Hobbies and Interests</h3>
                <p class="text-sm text-gray-600 mb-2">Select all that apply:</p>
                <div id="hobbiesContainer" class="flex flex-wrap -m-1 p-1">
                    <span class="text-sm text-gray-500">Loading hobbies...</span>
                </div>
            </div>

            <div class="tag-card">
                <h3 class="text-lg font-semibold text-gray-800">RECOMMEND ME TO CUSTOMERS WHO NEED</h3>
                <p class="text-sm text-gray-600 mb-2">Select the services you provide:</p>
                <div id="customersContainer" class="flex flex-wrap -m-1 p-1">
                    <span class="text-sm text-gray-500">Loading services...</span>
                </div>
            </div>

            <div class="tag-card">
                <h3 class="text-lg font-semibold text-gray-800">RECOMMEND ME TO NEARBY FRIENDS FOR</h3>
                <p class="text-sm text-gray-600 mb-2">Select reasons a friend may refer you:</p>
                <div id="friendsContainer" class="flex flex-wrap -m-1 p-1">
                    <span class="text-sm text-gray-500">Loading friends reasons...</span>
                </div>
            </div>

            <div class="continue-button-container">
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-full transition duration-150 ease-in-out shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50" aria-label="Continue to next step">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                    </svg>
                </button>
            </div>

        </form>
    </div>

    <div id="credentialsView" class="hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Create Your Account Credentials</h2>

        <form id="credentialsForm" class="space-y-6">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                <input type="email" id="email" name="email" placeholder="Enter your email" required>
            </div>

            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password:</label>
                <input type="password" id="password" name="password" placeholder="Enter your password" required>
                <div class="mt-2 h-2 rounded-full overflow-hidden">
                    <div id="password-strength-bar" class="h-full transition-all duration-500" style="width: 0%; background-color: transparent;"></div>
                </div>
                <small id="password-strength-text" class="text-xs text-gray-500 mt-1 block">
                    Password strength: **N/A**
                </small>
            </div>

            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg">
                JOIN WAIT-LIST
            </button>
            <button type="button" onclick="goToProfileView()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg mt-2">
                &larr; Back to Profile
            </button>
        </form>
    </div>

</div>

<div id="systemModal" class="modal-overlay">
    <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-lg">
        <h3 id="modalTitle" class="text-2xl font-bold text-green-600 mb-4"></h3>
        <p id="modalMessage" class="text-gray-700 mb-4"></p>
        <div id="finalData" class="bg-gray-100 p-4 rounded-lg text-sm whitespace-pre-wrap hidden"></div>
        <button onclick="document.getElementById('systemModal').classList.remove('open')" class="mt-6 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 rounded-lg">
            Close
        </button>
    </div>
</div>


<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // --- Supabase and R2 Configuration ---
    const R2_URL = 'https://pub-48a1c3e270fd40b49240608e1549146c.r2.dev/location_data.json';
    const supabaseUrl = 'https://zpoerahrcsbpxbztkgwl.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpwb2VyYWhyY3NicHhienRrZ3dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxODczMjUsImV4cCI6MjA3OTc2MzMyNX0.iMx9LGWrhn5dniTzxBBQ7GWcgzyxS5JsGrFBW-F1FjM';
    
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    // --- Global State and Data Storage ---
    let profileData = {};
    let locationData = []; 
    let selectedCountryStates = []; 
    
    // Dynamic data lists fetched from Supabase
    let _phoneCodes = [];
    let _hobbiesList = [];
    let _servicesList = [];
    let _friendsList = [];

    const selectedHobbies = new Set();
    const selectedServices = new Set();
    const selectedFriends = new Set();
    let isDataLoaded = false;


    // --- View Management Functions ---
    function goToProfileView() {
        document.getElementById('profileView').classList.remove('hidden');
        document.getElementById('credentialsView').classList.add('hidden');
    }

    function goToCredentialsView() {
        document.getElementById('profileView').classList.add('hidden');
        document.getElementById('credentialsView').classList.remove('hidden');
    }

    // --- Modal Message Handler ---
    function showModalMessage(title, message, isError = false, showData = false, dataContent = '') {
        const modal = document.getElementById('systemModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const finalDataContainer = document.getElementById('finalData');

        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalTitle.className = `text-2xl font-bold mb-4 ${isError ? 'text-red-600' : 'text-green-600'}`;
        
        if (showData) {
            finalDataContainer.innerHTML = dataContent;
            finalDataContainer.classList.remove('hidden');
        } else {
            finalDataContainer.classList.add('hidden');
        }

        modal.classList.add('open');
    }


    // --- Utility Function to Handle Tag Toggling ---
    function setupTagToggle(containerId, list, dataSet) {
        const container = document.getElementById(containerId);
        container.innerHTML = ''; 
        list.sort().forEach(item => { // Sort tags alphabetically
            const tag = document.createElement('span');
            tag.innerText = item;
            tag.classList.add('tag');

            tag.addEventListener('click', () => {
                tag.classList.toggle('selected');
                if (tag.classList.contains('selected')) {
                    dataSet.add(item);
                } else {
                    dataSet.delete(item);
                }
            });
            container.appendChild(tag);
        });
    }

    // --- Location Dropdown Management Functions ---
    const countrySelect = document.getElementById('country');
    const stateSelect = document.getElementById('state');
    const citySelect = document.getElementById('city');
    
    function resetStates() {
        stateSelect.innerHTML = '<option value="">Select State/Region</option>';
        stateSelect.disabled = true;
        resetCities();
    }

    function resetCities() {
        citySelect.innerHTML = '<option value="">Select City/Town</option>';
        citySelect.disabled = true;
    }
    
    async function loadLocationData() {
        try {
            const response = await fetch(R2_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            locationData = await response.json();
            populateCountries();
        } catch (error) {
            console.error("Failed to load location data from R2:", error);
            countrySelect.innerHTML = '<option value="">Error Loading Data</option>';
            throw new Error('Location data failed to load.'); // Propagate error
        }
    }

    function populateCountries() {
        countrySelect.innerHTML = '<option value="">Select Country</option>';
        
        locationData.sort((a, b) => a.name.localeCompare(b.name)).forEach(country => {
            const option = document.createElement('option');
            option.value = country.name;
            option.text = country.name;
            countrySelect.appendChild(option);
        });
        countrySelect.disabled = false;
    }

    function populateStates(countryName) {
        resetStates();
        
        const country = locationData.find(c => c.name === countryName);
        
        if (!country || !country.states || country.states.length === 0) {
            stateSelect.innerHTML = '<option value="N/A">No States/Regions Found (Select this)</option>';
            stateSelect.disabled = false;
            return;
        }

        selectedCountryStates = country.states; 
        
        stateSelect.disabled = false;
        
        const stateNames = selectedCountryStates.map(s => s.name).sort();
        stateNames.forEach(stateName => {
            const option = document.createElement('option');
            option.value = stateName;
            option.text = stateName;
            stateSelect.appendChild(option);
        });
    }

    function populateCities(stateName) {
        resetCities();
        
        const state = selectedCountryStates.find(s => s.name === stateName);
        
        if (!state || !state.cities || state.cities.length === 0) {
            citySelect.innerHTML = '<option value="N/A">No Cities Found (Select this)</option>';
            citySelect.disabled = false;
            return;
        }

        citySelect.disabled = false;
        
        const cityNames = state.cities.map(c => c.name).sort();
        cityNames.forEach(cityName => {
            const option = document.createElement('option');
            option.value = cityName;
            option.text = cityName;
            citySelect.appendChild(option);
        });
    }
    
    // --- Supabase Fetching Functions ---

    async function fetchPhoneCodes() {
        try {
            // Assuming a table named 'phone_codes'
            const { data, error } = await supabase
                .from('phone_codes')
                .select('*');

            if (error) throw error;
            _phoneCodes = data || [];
        } catch (error) {
            console.error("Supabase Error fetching phone codes:", error.message);
            throw new Error('Phone codes failed to load from Supabase.');
        }
    }

    async function fetchTagList(tableName) {
        try {
            // Assuming tables named 'hobbies', 'services', 'friends'
            const { data, error } = await supabase
                .from(tableName)
                .select('name'); // Assuming the tag value is stored in a 'name' column

            if (error) throw error;
            // Map the result to a simple array of strings (the tag names)
            return (data || []).map(item => item.name);
        } catch (error) {
            console.error(`Supabase Error fetching tags from ${tableName}:`, error.message);
            throw new Error(`${tableName} list failed to load from Supabase.`);
        }
    }

    function populatePhoneCodes() {
        const codeSelect = document.getElementById('countryCode');
        codeSelect.innerHTML = '<option value="">Code</option>';

        _phoneCodes.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
            const option = document.createElement('option');
            option.text = `${item.name} (${item.code})`; 
            option.value = item.code; 
            option.setAttribute('data-placeholder', item.placeholder || 'Enter local number'); 
            // The `expected_digits` is critical for validation
            option.setAttribute('data-expected-digits', item.expected_digits || 0); 
            codeSelect.appendChild(option);
        });
    }


    // --- Custom Validation Logic (Uses dynamically loaded _phoneCodes) ---

    function validatePhoneNumber(countryCode, localNumber) {
        const errorElement = document.getElementById('whatsapp-error');
        const cleanLocalNumber = localNumber.replace(/\D/g, ''); 
        
        errorElement.classList.add('hidden'); 
        
        if (!countryCode || cleanLocalNumber.length === 0) {
            return true; 
        }

        const countryData = _phoneCodes.find(item => item.code === countryCode);
        
        if (!countryData || !countryData.expected_digits) {
            // If code is selected but data is missing, we must fail validation to be safe
            errorElement.textContent = `Error: Missing validation data for ${countryCode}`;
            errorElement.classList.remove('hidden');
            return false; 
        }

        const actualDigits = cleanLocalNumber.length;
        const expectedDigits = countryData.expected_digits; 
        
        const isValid = (actualDigits === expectedDigits);
        
        if (!isValid) {
            errorElement.textContent = `The number must contain exactly ${expectedDigits} digits for this country. You entered ${actualDigits}.`;
            errorElement.classList.remove('hidden');
            return false;
        } 
        
        return true;
    }
    
    // --- Password Strength Logic ---
    function checkPasswordStrength(password) {
        const barElement = document.getElementById('password-strength-bar');
        const textElement = document.getElementById('password-strength-text');
        
        if (password.length === 0) {
            barElement.style.width = '0%';
            barElement.style.backgroundColor = 'transparent';
            textElement.innerHTML = `Password strength: **N/A**`;
            return false;
        }

        let strength = 0;
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            symbol: /[^A-Za-z0-9]/.test(password)
        };

        if (requirements.length) strength += 1;
        if (requirements.uppercase && requirements.lowercase) strength += 1;
        if (requirements.number) strength += 1;
        if (requirements.symbol) strength += 1;
        
        let strengthText = 'N/A';
        let barColor = 'transparent';
        let barWidth = '0%';

        if (strength === 0 || strength === 1) {
            strengthText = 'Very Weak';
            barColor = 'rgb(239, 68, 68)'; 
            barWidth = '25%';
        } else if (strength === 2) {
            strengthText = 'Weak';
            barColor = 'rgb(245, 158, 11)'; 
            barWidth = '50%';
        } else if (strength === 3) {
            strengthText = 'Moderate';
            barColor = 'rgb(59, 130, 246)'; 
            barWidth = '75%';
        } else if (strength === 4) {
            strengthText = 'Strong';
            barColor = 'rgb(16, 185, 129)'; 
            barWidth = '100%';
        }

        barElement.style.width = barWidth;
        barElement.style.backgroundColor = barColor;
        textElement.innerHTML = `Password strength: **${strengthText}**`;

        return password.length > 0;
    }


    // --- Initialization on Load ---
    window.onload = async function() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        const codeSelect = document.getElementById('countryCode');
        const numberInput = document.getElementById('whatsappNumber');
        const passwordInput = document.getElementById('password'); 

        // 1. Fetch all dynamic data concurrently
        try {
            const [codes, hobbies, services, friends] = await Promise.all([
                fetchPhoneCodes(),
                fetchTagList('hobbies'),
                fetchTagList('services'),
                fetchTagList('friends'),
                loadLocationData() // R2 fetch
            ]);

            // Assign fetched lists to global variables
            _hobbiesList = hobbies;
            _servicesList = services;
            _friendsList = friends;
            
            // 2. Populate UI elements
            populatePhoneCodes();

            document.getElementById('password-strength-text').innerHTML = `Password strength: **N/A**`;

            // Setup Age Options
            const ageSelect = document.getElementById('age');
            for (let i = 18; i <= 100; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.text = i;
                ageSelect.appendChild(option);
            }
            
            // Setup Tags
            setupTagToggle('hobbiesContainer', _hobbiesList, selectedHobbies);
            setupTagToggle('customersContainer', _servicesList, selectedServices);
            setupTagToggle('friendsContainer', _friendsList, selectedFriends);

            // 3. Setup Event Listeners

            // Phone number listeners
            codeSelect.addEventListener('change', () => {
                const selectedOption = codeSelect.options[codeSelect.selectedIndex];
                const newPlaceholder = selectedOption?.getAttribute('data-placeholder') || 'Enter local number'; 
                numberInput.placeholder = newPlaceholder;
                validatePhoneNumber(codeSelect.value, numberInput.value); 
            });
            numberInput.addEventListener('input', () => {
                validatePhoneNumber(codeSelect.value, numberInput.value); 
            });

            // Location listeners
            countrySelect.addEventListener('change', () => populateStates(countrySelect.value));
            stateSelect.addEventListener('change', () => populateCities(stateSelect.value));

            // Password listener
            passwordInput.addEventListener('input', (e) => {
                checkPasswordStrength(e.target.value);
            });
            
            // Form 1 Submission
            document.getElementById('signupForm').addEventListener('submit', function(e) {
                e.preventDefault();

                const countryCode = document.getElementById('countryCode').value;
                const localNumber = document.getElementById('whatsappNumber').value.trim();

                // 1. Validation
                if (!countryCode || !localNumber) {
                    showModalMessage('Validation Error','Please select a Country Code and enter a Phone Number.', true);
                    return;
                }
                if (!validatePhoneNumber(countryCode, localNumber)) {
                    showModalMessage('Validation Error','The entered phone number must contain the correct number of digits for the selected country. Please check the error message above the number field.', true);
                    return;
                }
                if (!countrySelect.value || !stateSelect.value || !citySelect.value) {
                    showModalMessage('Validation Error','Please select a Country, State/Region, and City/Town.',true);
                    return;
                }
                if (selectedHobbies.size === 0) {
                    showModalMessage('Validation Error','Please select at least one option for "Hobbies and Interests" to proceed.',true);
                    return;
                }

                // 2. Collect & Proceed
                const cleanLocalNumber = localNumber.replace(/\D/g, ''); 
                const fullWhatsappNumber = countryCode + cleanLocalNumber;

                profileData = {
                    'whatsapp_number': fullWhatsappNumber, 
                    'full_name': document.getElementById('fullname').value.trim(),
                    'nickname': document.getElementById('nickname').value.trim(),
                    'profession': document.getElementById('profession').value.trim() || null, 
                    'age': document.getElementById('age').value,
                    'gender': document.getElementById('gender').value,
                    'country': countrySelect.value,
                    'state': stateSelect.value === 'N/A' ? countrySelect.value : stateSelect.value,
                    'city': citySelect.value === 'N/A' ? (stateSelect.value === 'N/A' ? countrySelect.value : stateSelect.value) : citySelect.value,
                    'hobbies': Array.from(selectedHobbies),
                    'services': Array.from(selectedServices),
                    'friend_reasons': Array.from(selectedFriends)
                };

                goToCredentialsView();
            });

            // Form 2 Submission
            document.getElementById('credentialsForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (passwordInput.value.length === 0) {
                    showModalMessage('Validation Error','Please enter a password.', true);
                    return;
                }

                const email = document.getElementById('email').value.trim();
                const password = passwordInput.value;

                const finalSubmission = {
                    ...profileData,
                    email: email,
                    password: password 
                };
                
                // --- ACTUAL SUBMISSION SIMULATION ---
                // In a real app, you would submit `finalSubmission` to your backend/Supabase Auth here.
                
                // Simulate success and show data
                const dataString = JSON.stringify(finalSubmission, null, 2);
                showModalMessage('Success! Joining Wait-List', 
                    'Your profile has been created and your credentials are ready. In a live environment, this data would now be submitted.', 
                    false, true, dataString);

                // Original instruction to redirect to leaderboard.html
                // window.location.href = 'leaderboard.html';
            });
            
            // Hide loading overlay and set data loaded flag
            isDataLoaded = true;
            loadingOverlay.classList.add('hidden');

        } catch (error) {
            console.error("Critical initialization error:", error);
            loadingOverlay.innerHTML = `
                <h3 class="text-xl font-bold text-red-600 mb-2">Application Load Failed</h3>
                <p class="text-red-700 text-center px-4">An error occurred while fetching required data: ${error.message}. Please check your Supabase and R2 configuration.</p>
            `;
            // Keep the error message visible
        }
    };
</script>

</body>
</html>

